<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>媒介契約管理システム - センチュリー21ミライズ不動産</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root {
      --primary-color: #1a56db;
      --primary-hover: #1e429f;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --info-color: #3b82f6;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
      --sidebar-bg: #1e3a5f;
      --sidebar-active: #2563eb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
    }

    .hidden { display: none !important; }
    .app { display: flex; min-height: 100vh; }

    /* Sidebar */
    .sidebar {
      width: 170px;
      height: 100vh;
      background-color: var(--sidebar-bg);
      color: #fff;
      position: fixed;
      left: 0;
      top: 0;
      z-index: 1000;
      overflow-y: auto;
    }

    .sidebar-header {
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-header .menu-icon { font-size: 20px; cursor: pointer; }
    .sidebar-logo { height: 32px; width: auto; border-radius: 4px; background: #fff; padding: 2px; flex-shrink: 0; }
    .sidebar-header .logo-text { display: flex; flex-direction: column; line-height: 1.2; min-width: 0; }
    .sidebar-header .logo-main { font-size: 10px; color: rgba(255, 255, 255, 0.8); }
    .sidebar-header .logo-sub { font-size: 11px; font-weight: 700; color: #fff; white-space: nowrap; }

    .sidebar-menu { list-style: none; margin: 0; padding: 0; }
    .menu-item {
      padding: 12px 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: background-color 0.2s;
      border-left: 3px solid transparent;
      font-size: 13px;
    }
    .menu-item:hover { background: rgba(255, 255, 255, 0.1); }
    .menu-item.active { background: var(--sidebar-active); border-left-color: #60a5fa; }
    .menu-item.disabled { opacity: 0.5; cursor: not-allowed; }
    .menu-item .icon { width: 24px; text-align: center; }

    /* Header */
    .main-area { flex: 1; margin-left: 170px; min-height: 100vh; display: flex; flex-direction: column; }
    .header {
      height: 50px;
      background: #fff;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
      position: sticky;
      top: 0;
      z-index: 900;
    }
    .header-left { font-weight: 600; color: var(--gray-700); }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .header-icon-btn {
      width: 36px; height: 36px; border: 1px solid var(--gray-200);
      border-radius: 50%; background: #fff; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; transition: background 0.2s;
    }
    .header-icon-btn:hover { background: var(--gray-100); }
    .header-user { font-size: 13px; color: var(--gray-700); }
    .logout-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid var(--gray-200); background: #fff; cursor: pointer; font-size: 12px; }

    /* 通知関連 */
    .notification-wrapper { position: relative; }
    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--danger-color);
      color: #fff;
      font-size: 10px;
      font-weight: 700;
      min-width: 18px;
      height: 18px;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }
    .notification-dropdown {
      position: absolute;
      top: 45px;
      right: 0;
      width: 360px;
      max-height: 400px;
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow: hidden;
    }
    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-200);
      font-weight: 600;
      font-size: 14px;
    }
    .notification-clear {
      font-size: 12px;
      color: var(--primary-color);
      background: none;
      border: none;
      cursor: pointer;
    }
    .notification-clear:hover { text-decoration: underline; }
    .notification-list {
      max-height: 340px;
      overflow-y: auto;
    }
    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--gray-100);
      cursor: pointer;
      transition: background 0.2s;
    }
    .notification-item:hover { background: var(--gray-50); }
    .notification-item.unread { background: #eff6ff; }
    .notification-item-icon {
      display: inline-block;
      width: 24px;
      text-align: center;
      margin-right: 8px;
    }
    .notification-item-text {
      font-size: 13px;
      color: var(--gray-700);
      line-height: 1.4;
    }
    .notification-item-date {
      font-size: 11px;
      color: var(--gray-500);
      margin-top: 4px;
    }
    .notification-empty {
      padding: 32px 16px;
      text-align: center;
      color: var(--gray-500);
      font-size: 13px;
    }
    
    /* 通知モーダル内 */
    .notification-section {
      margin-bottom: 20px;
    }
    .notification-section-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--gray-700);
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--gray-200);
    }
    .notification-modal-item {
      padding: 10px 12px;
      margin-bottom: 8px;
      border-radius: 6px;
      font-size: 13px;
    }
    .notification-modal-item.deadline { background: #fef2f2; border-left: 4px solid var(--danger-color); }
    .notification-modal-item.deadline-warning { background: #fffbeb; border-left: 4px solid var(--warning-color); }
    .notification-modal-item.status { background: #eff6ff; border-left: 4px solid var(--info-color); }
    .notification-modal-item.price { background: #ecfdf5; border-left: 4px solid var(--success-color); }
    
    /* ユーザードロップダウン */
    .user-wrapper { position: relative; }
    .user-dropdown {
      position: absolute;
      top: 45px;
      right: 0;
      width: 240px;
      background: #fff;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      overflow: hidden;
    }
    .user-dropdown-header {
      padding: 16px;
      background: var(--gray-50);
      border-bottom: 1px solid var(--gray-200);
    }
    .user-dropdown-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--gray-900);
    }
    .user-dropdown-id {
      font-size: 12px;
      color: var(--gray-500);
      margin-top: 4px;
    }
    .user-dropdown-menu {
      padding: 8px;
    }
    .user-dropdown-item {
      display: block;
      width: 100%;
      padding: 10px 12px;
      text-align: left;
      background: none;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      color: var(--gray-700);
      cursor: pointer;
      transition: background 0.2s;
    }
    .user-dropdown-item:hover {
      background: var(--gray-100);
    }

    /* Content */
    .content { padding: 20px; flex: 1; }
    .page-title { margin: 0 0 16px 0; font-size: 18px; font-weight: 700; color: var(--gray-900); }
    .stats-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
    .stats-column { display: flex; flex-direction: column; gap: 12px; flex: 0 1 320px; min-width: 260px; }
    .stats-card { background: #fff; border: 1px solid var(--gray-200); border-radius: 8px; padding: 16px 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
    .inventory-card { min-width: 240px; }
    .stats-title { font-size: 14px; margin: 0 0 8px 0; color: var(--gray-700); }
    .stats-number { font-size: 32px; font-weight: 700; color: var(--gray-900); }
    .stats-subtitle { font-size: 13px; color: var(--gray-500); margin: 0; }
    .stats-change.positive { color: var(--success-color); }
    .stats-change.negative { color: var(--danger-color); }

    .chart-card { flex: 1; min-width: 480px; }
    .chart-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .chart-title { margin: 0; font-size: 14px; font-weight: 700; color: #1f2937; }
    .chart-legend { display: flex; gap: 12px; align-items: center; font-size: 12px; color: var(--gray-500); }
    .legend-item { display: flex; align-items: center; gap: 6px; }
    .legend-color { width: 12px; height: 12px; border-radius: 2px; display: inline-block; }
    .legend-color.senzoku { background: #3b82f6; }
    .legend-color.senin { background: #10b981; }
    .legend-color.ippan { background: #f59e0b; }
    .chart-container { height: 180px; }
    .staff-summary { font-size: 13px; color: #374151; line-height: 1.8; }
    .staff-summary-row { padding: 2px 0; }
    .goal-card { background: #fff; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin: 16px 0; }
    .goal-header { display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 12px; }
    .goal-title { margin: 0; font-size: 15px; font-weight: 700; color: var(--gray-900); }
    .goal-action { font-size: 12px; color: var(--primary-color); background: transparent; border: 1px solid var(--primary-color); padding: 6px 10px; border-radius: 6px; cursor: pointer; }
    .goal-action:hover { background: #eff6ff; }
    .goal-overview { display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 12px; }
    .goal-pill { padding: 8px 12px; border-radius: 8px; background: var(--gray-100); font-size: 13px; color: var(--gray-700); }
    .goal-progress-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .goal-item { border: 1px solid var(--gray-200); border-radius: 8px; padding: 10px 12px; }
    .goal-item-header { display: flex; justify-content: space-between; align-items: center; font-size: 13px; color: var(--gray-700); margin-bottom: 6px; }
    .goal-progress { width: 100%; height: 10px; border-radius: 999px; background: var(--gray-200); overflow: hidden; }
    .goal-progress-bar { height: 100%; background: linear-gradient(90deg, #22c55e, #16a34a); }
    .goal-progress-text { margin-top: 6px; font-size: 12px; color: var(--gray-600); }

    /* Alert */
    .alert-banner { display: flex; align-items: center; padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; border: 1px solid #fcd34d; background: #fffbeb; gap: 12px; }
    .alert-icon { font-size: 18px; }
    .alert-text { flex: 1; font-size: 14px; color: #92400e; }
    .alert-btn { background: transparent; border: 1px solid #d97706; color: #d97706; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 13px; }
    .alert-btn:hover { background: #fef3c7; }

    /* Filters */
    .filter-bar { display: flex; justify-content: space-between; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    .filter-left, .filter-right { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .filter-select, .search-input { padding: 8px 12px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px; background: #fff; min-width: 120px; }
    .search-input { min-width: 180px; }
    .date-range { display: flex; align-items: center; gap: 8px; padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; background: #fff; font-size: 13px; }
    .date-input { border: none; font-size: 13px; color: var(--gray-700); background: transparent; }
    .btn { padding: 8px 14px; border-radius: 6px; font-size: 13px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; border: 1px solid transparent; transition: all 0.2s ease; }
    .btn-primary { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-outline { background: #fff; color: var(--gray-800); border-color: var(--gray-300); }
    .btn-outline:hover { background: var(--gray-100); }
    .btn-danger { background: var(--danger-color); color: #fff; border-color: var(--danger-color); }
    .btn-danger:hover { background: #d52e2e; }
    .goal-settings-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .goal-settings-table th, .goal-settings-table td { padding: 8px; border-bottom: 1px solid var(--gray-200); text-align: left; }
    .goal-settings-table th { background: var(--gray-100); font-size: 13px; }
    .goal-input { width: 120px; padding: 6px 8px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px; }

    /* Table */
    .table-container { background: #fff; border: 1px solid var(--gray-200); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    thead { background: var(--gray-100); position: sticky; top: 0; z-index: 10; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--gray-200); vertical-align: top; text-align: left; white-space: nowrap; }
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { color: var(--primary-color); }
    td.address { max-width: 240px; width: 240px; white-space: normal; word-break: break-word; }
    .badge { display: inline-flex; align-items: center; justify-content: center; padding: 3px 8px; border-radius: 999px; font-size: 11px; font-weight: 600; }
    .badge.type-専属 { background: #3b82f6; color: #fff; }
    .badge.type-専任 { background: #10b981; color: #fff; }
    .badge.type-一般 { background: #f59e0b; color: #fff; }
    .badge.flag-yes { background: #d1fae5; color: #047857; }
    .badge.flag-no { background: #fee2e2; color: #991b1b; }
    .actions { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-start; }
    .actions .btn { padding: 6px 10px; font-size: 12px; }
    .row-soft-warning { background: #fff7ed; }
    .row-danger { background: #fef2f2; }
    .row-closed { background: #ecfdf3; }
    .row-cancel { background: #f3f4f6; }
    th[data-key="price"], #contractsBody td:nth-child(10) { font-weight: 700; }

    /* Sections */
    .page-section { display: none; }
    .page-section.active { display: block; }
    .section-card { background: #fff; border: 1px solid var(--gray-200); border-radius: 10px; padding: 16px 18px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 16px; }
    .section-title { margin: 0 0 12px; font-size: 16px; font-weight: 700; color: var(--gray-900); }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 1200; }
    .modal { background: #fff; border-radius: 10px; max-width: 820px; width: 90%; max-height: 90vh; overflow: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.12); padding: 20px 24px 16px; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .modal-title { font-size: 16px; font-weight: 700; margin: 0; }
    .modal-close { background: transparent; border: none; font-size: 20px; cursor: pointer; color: var(--gray-500); }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; margin-bottom: 12px; }
    .form-group { display: flex; flex-direction: column; gap: 4px; font-size: 12px; color: var(--gray-700); }
    .form-group label { font-weight: 600; }
    .form-group input, .form-group select, .form-group textarea { border: 1px solid var(--gray-300); border-radius: 6px; padding: 8px 10px; font-size: 13px; width: 100%; background: #fff; color: var(--gray-900); }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 4px; }
    #contractModalActions { justify-content: space-between; align-items: center; gap: 8px; flex-wrap: wrap; }

    /* Login */
    .login-wrap { display: flex; min-height: 100vh; align-items: center; justify-content: center; background: linear-gradient(135deg, #1a56db 0%, #0f172a 100%); padding: 20px; }
    .login-card { background: #fff; width: 380px; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.25); padding: 24px 28px; }
    .login-title { margin: 0 0 4px; font-size: 20px; font-weight: 700; color: var(--gray-900); }
    .login-subtitle { margin: 0 0 20px; color: var(--gray-500); font-size: 13px; }
    .error-text { color: var(--danger-color); font-size: 12px; margin-top: 6px; }

    @media (max-width: 960px) {
      .main-area { margin-left: 0; }
      .sidebar { position: fixed; transform: translateX(-100%); transition: transform 0.2s; }
      .sidebar.open { transform: translateX(0); }
      .header { position: sticky; top: 0; }
    }

    /* 顧客管理 */
    .customer-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 16px;
      border-bottom: 2px solid var(--gray-200);
    }
    .customer-tab {
      padding: 10px 24px;
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-500);
      cursor: pointer;
      transition: all 0.2s;
    }
    .customer-tab:hover {
      color: var(--primary-color);
    }
    .customer-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }

    .customer-status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
      line-height: 1.2;
      text-align: center;
    }

    /* 顧客テーブル行ホバー */
    #customersBody tr:hover {
      background: var(--gray-100);
    }

    .progress-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      margin: 1px 2px;
      white-space: nowrap;
    }
    .progress-badge.done { background: #22C55E; color: #fff; }
    .progress-badge.pending { background: #e5e7eb; color: #6b7280; }

    .progress-badges-wrap {
      display: flex;
      flex-wrap: nowrap;
      gap: 2px;
    }

    .progress-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .progress-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: var(--gray-100);
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .progress-item:hover {
      background: var(--gray-200);
    }
    .progress-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--success-color);
    }
    .progress-item input[type="checkbox"]:checked + span {
      color: var(--success-color);
      font-weight: 500;
    }

    .category-fields.hidden { display: none; }

    .customer-detail-grid {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 8px 16px;
      font-size: 13px;
    }
    .customer-detail-label {
      color: var(--gray-500);
      font-weight: 500;
    }
    .customer-detail-value {
      color: var(--gray-900);
    }

    .pagination-btn {
      padding: 6px 12px;
      border: 1px solid var(--gray-200);
      background: #fff;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .pagination-btn:hover:not(:disabled) {
      background: var(--gray-100);
    }
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .pagination-btn.active {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }

    .btn-danger {
      background: var(--danger-color);
      color: #fff;
      border: none;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
  </style>
</head>
<body>
  <div id="loginView" class="login-wrap">
    <div class="login-card">
      <h1 class="login-title">媒介契約管理システム</h1>
      <p class="login-subtitle">ログインして利用を開始してください</p>
      <form id="loginForm">
        <div class="form-group">
          <label for="loginId">ログインID</label>
          <input id="loginId" name="id" autocomplete="username">
        </div>
        <div class="form-group">
          <label for="loginPassword">パスワード</label>
          <input id="loginPassword" name="password" type="password" autocomplete="current-password">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; margin-top: 12px;">ログイン</button>
        <div id="loginError" class="error-text hidden"></div>
      </form>
    </div>
  </div>

  <div id="app" class="app hidden">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <span class="menu-icon" id="sidebarToggle">☰</span>
        <img src="/static/logo.jpg" alt="MIRAIZU" class="sidebar-logo">
        <div class="logo-text">
          <span class="logo-main">不動産売買</span>
          <span class="logo-sub">媒介管理</span>
        </div>
      </div>
      <ul class="sidebar-menu">
        <li class="menu-item active" data-page="dashboard"><span class="icon">🏠</span><span>ダッシュボード</span></li>
        <li class="menu-item" data-page="contracts"><span class="icon">📋</span><span>媒介契約一覧</span></li>
        <li class="menu-item" data-page="customers"><span class="icon">👥</span><span>顧客管理</span></li>
        <li class="menu-item" data-page="deadline"><span class="icon">📅</span><span>期限カレンダー</span></li>
        <li class="menu-item" data-page="register"><span class="icon">✏️</span><span>媒介登録</span></li>
        <li class="menu-item" data-page="closed-contracted"><span class="icon">✅</span><span>成約リスト</span></li>
        <li class="menu-item" data-page="closed-purchased"><span class="icon">💰</span><span>買取リスト</span></li>
        <li class="menu-item" data-page="closed-canceled"><span class="icon">⛔</span><span>中止リスト</span></li>
        <li class="menu-item" data-page="by-staff"><span class="icon">👤</span><span>担当別管理</span></li>
        <li class="menu-item" data-page="settings"><span class="icon">⚙️</span><span>設定</span></li>
        <li class="menu-item" data-page="admin"><span class="icon">🗑️</span><span>削除管理</span></li>
      </ul>
    </aside>

    <div class="main-area">
      <header class="header">
        <div class="header-left">不動産売買 媒介管理</div>
        <div class="header-right">
          <div class="notification-wrapper">
            <button class="header-icon-btn" title="通知" id="notificationBtn">🔔</button>
            <span class="notification-badge hidden" id="notificationBadge">0</span>
            <div class="notification-dropdown hidden" id="notificationDropdown">
              <div class="notification-header">
                <span>通知</span>
                <button class="notification-clear" id="clearAllNotifications">すべて既読</button>
              </div>
              <div class="notification-list" id="notificationList"></div>
            </div>
          </div>
          <div class="header-user" id="currentUser">-</div>
          <div class="user-wrapper">
            <button class="header-icon-btn" title="ユーザー" id="userBtn">👤</button>
            <div class="user-dropdown hidden" id="userDropdown">
              <div class="user-dropdown-header">
                <div class="user-dropdown-name" id="userDropdownName">-</div>
                <div class="user-dropdown-id" id="userDropdownId">-</div>
              </div>
              <div class="user-dropdown-menu">
                <button class="user-dropdown-item" id="btnChangePassword">🔑 パスワード変更</button>
                <button class="user-dropdown-item" id="btnUserList">👥 ユーザー一覧</button>
              </div>
            </div>
          </div>
          <button class="logout-btn" id="logoutBtn">ログアウト</button>
        </div>
      </header>

      <main class="content">
        <section id="page-dashboard" class="page-section active">
          <h2 class="page-title">ダッシュボード</h2>

          <div class="stats-row">
            <div class="stats-column">
              <div class="stats-card inventory-card">
                <h3 class="stats-title">現在の店内在庫数</h3>
                <div class="stats-number" id="inventoryCount">0</div>
                <button class="btn btn-outline" id="btnMonthlyTrend" style="margin-top:8px;">推移を表示</button>
              </div>
              <div class="stats-card">
                <h3 class="stats-title">担当別サマリー</h3>
                <div class="staff-summary" id="staffSummary"></div>
              </div>
            </div>

            <div class="stats-card chart-card">
              <div class="chart-header">
                <h3 class="chart-title">担当別・媒介種別ごとの媒介数</h3>
                <div class="chart-legend">
                  <span class="legend-item"><span class="legend-color senzoku"></span>専属</span>
                  <span class="legend-item"><span class="legend-color senin"></span>専任</span>
                  <span class="legend-item"><span class="legend-color ippan"></span>一般</span>
                </div>
              </div>
              <div class="chart-container">
                <canvas id="staffChart"></canvas>
              </div>
            </div>
          </div>
          <div class="goal-card" id="goalSummaryCard">
            <div class="goal-header">
              <h3 class="goal-title">月間目標達成状況</h3>
              <button class="goal-action" id="btnOpenGoalSettings">🎯 目標を設定</button>
            </div>
            <div class="goal-overview" id="goalOverview"></div>
            <div class="goal-progress-list" id="goalStaffList"></div>
          </div>

          <div class="alert-banner" id="alertBanner">
            <span class="alert-icon">⚠️</span>
            <span class="alert-text" id="alertText">【重要】期間切れ間近の契約が0件あります。ご確認ください。</span>
            <button class="alert-btn" id="alertDetailBtn">詳細を見る</button>
          </div>
          <div class="filter-bar">
            <div class="filter-left">
              <select class="filter-select" id="filterStaff"></select>
              <select class="filter-select" id="filterStatus"></select>
              <div class="date-range">
                <span class="date-icon">📅</span>
                <input type="date" class="date-input" id="dateFrom">
                <span class="date-separator">〜</span>
                <input type="date" class="date-input" id="dateTo">
              </div>
              <input type="text" class="search-input" id="searchInput" placeholder="フリーワード検索（所在地・売主・媒介No.）">
            </div>
            <div class="filter-right">
              <button class="btn btn-primary" id="btnNewContract">新規媒介登録</button>
              <button class="btn btn-outline" id="btnNewPurchase">🛒 新規買取登録</button>
              <button class="btn btn-outline" id="btnDeadlineView">📅 期限ビュー</button>
              <button class="btn btn-outline" id="btnShowClosed">契約済み/中止</button>
              <button class="btn btn-outline" id="btnMasters">マスター管理</button>
              <button class="btn btn-outline" id="btnStatusColors">ラベル色設定</button>
              <button class="btn btn-outline" id="btnLockManageTop">🔓 ロック解除</button>
              <button class="btn btn-outline" id="btnExportDashboard">📤 CSV出力</button>
            </div>
          </div>

          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th class="sortable" data-key="id">媒介No.</th>
                  <th>取引状況</th>
                  <th>反響媒体</th>
                  <th class="sortable" data-key="staff">担当</th>
                  <th>媒介</th>
                  <th>物件種別</th>
                  <th style="min-width:180px;">物件所在地（市町村から）</th>
                  <th>売主氏名</th>
                  <th>売主連絡先</th>
                  <th class="sortable" data-key="price">媒介価格</th>
                  <th>価格推移</th>
                  <th class="sortable" data-key="signedDate">初回媒介日</th>
                  <th class="sortable" data-key="expireDate">媒介期日</th>
                  <th>レインズ期日</th>
                  <th>鍵</th>
                  <th class="sortable" data-key="condition">現況</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="contractsBody"></tbody>
            </table>
          </div>
        </section>

        <section id="page-deadline" class="page-section">
          <h2 class="page-title">期限カレンダー</h2>
          <div class="section-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h3 class="section-title" style="margin:0;">期限が近い案件</h3>
              <button class="btn btn-outline" id="btnExportDeadline">📤 CSV出力</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>媒介No.</th>
                    <th>担当</th>
                    <th>取引状況</th>
                    <th>媒介期日</th>
                    <th>残日数</th>
                    <th>物件所在地（市町村から）</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="deadlineBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-register" class="page-section">
          <h2 class="page-title">媒介登録</h2>
          <div class="section-card">
            <p class="stats-subtitle">新規登録は「新規媒介登録」ボタンからモーダルで入力できます。</p>
            <button class="btn btn-primary" id="btnNewContract2">新規媒介登録</button>
          </div>
          <div class="section-card">
            <h3 class="section-title">現在の登録一覧</h3>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>媒介No.</th>
                    <th>担当</th>
                    <th>種別</th>
                    <th>初回媒介日</th>
                    <th>媒介期日</th>
                    <th>物件所在地（市町村から）</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="registerBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-closed-contracted" class="page-section">
          <h2 class="page-title">成約リスト</h2>
          <div class="section-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h3 class="section-title" style="margin:0;">成約リスト</h3>
              <div style="display:flex;gap:8px;align-items:center;">
                <input type="text" class="search-input" id="closedSearchContracted" placeholder="検索 (媒介No./担当/所在地など)">
                <button class="btn btn-outline" id="btnExportClosed">📤 CSV出力</button>
              </div>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>媒介No.</th>
                    <th>担当</th>
                    <th>種別</th>
                    <th>物件所在地（市町村から）</th>
                    <th>成約情報</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="closedContractedBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-closed-purchased" class="page-section">
          <h2 class="page-title">買取リスト</h2>
          <div class="section-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h3 class="section-title" style="margin:0;">買取リスト</h3>
              <input type="text" class="search-input" id="closedSearchPurchased" placeholder="検索 (媒介No./担当/所在地など)">
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>媒介No.</th>
                    <th>担当</th>
                    <th>種別</th>
                    <th>物件所在地（市町村から）</th>
                    <th>買取情報</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="closedPurchasedBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-closed-canceled" class="page-section">
          <h2 class="page-title">中止リスト</h2>
          <div class="section-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h3 class="section-title" style="margin:0;">中止リスト</h3>
              <input type="text" class="search-input" id="closedSearchCanceled" placeholder="検索 (媒介No./担当/所在地など)">
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>媒介No.</th>
                    <th>担当</th>
                    <th>種別</th>
                    <th>物件所在地（市町村から）</th>
                    <th>中止情報</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="closedCanceledBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-by-staff" class="page-section">
          <h2 class="page-title">担当別管理</h2>
          <div class="section-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h3 class="section-title" style="margin:0;">担当別集計</h3>
              <button class="btn btn-outline" id="btnExportByStaff">📤 CSV出力</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>担当</th>
                    <th>専属</th>
                    <th>専任</th>
                    <th>一般</th>
                    <th>合計</th>
                  </tr>
                </thead>
                <tbody id="byStaffBody"></tbody>
              </table>
            </div>
          </div>
          <div class="section-card">
            <h3 class="section-title">担当別案件一覧</h3>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>担当</th>
                    <th>媒介No.</th>
                    <th>種別</th>
                    <th>取引状況</th>
                    <th>媒介期日</th>
                    <th>物件所在地（市町村から）</th>
                  </tr>
                </thead>
                <tbody id="byStaffContractsBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="page-settings" class="page-section">
          <h2 class="page-title">設定</h2>
          <div class="section-card">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
              <h3 class="section-title" style="margin:0;">月間目標設定</h3>
              <button class="btn btn-primary" id="btnSaveGoals">保存</button>
            </div>
            <div class="goal-pill" style="margin-bottom:8px;">目標値は今月の媒介件数（一般・専任・専属合計）で管理します</div>
            <table class="goal-settings-table">
              <thead>
                <tr>
                  <th style="min-width:160px;">区分</th>
                  <th>目標件数</th>
                  <th>対象</th>
                </tr>
              </thead>
              <tbody id="goalSettingsBody"></tbody>
            </table>
          </div>
        </section>

        <section id="page-admin" class="page-section">
          <h2 class="page-title">削除管理</h2>
          <div class="section-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <p class="stats-subtitle" style="margin: 0;">全案件を一覧表示し、必要に応じて削除できます。</p>
              <button class="btn btn-outline" id="btnBackupManage">🗄️ バックアップ管理</button>
              <button class="btn btn-outline" id="btnLockManage">🔒 ロック管理</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>媒介No.</th>
                    <th>取引状況</th>
                    <th>担当</th>
                    <th>物件所在地（市町村から）</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="adminBody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- 顧客管理ページ -->
        <section id="page-customers" class="page-section">
          <h2 class="page-title">顧客管理</h2>

          <!-- タブ切り替え -->
          <div class="customer-tabs">
            <button class="customer-tab active" data-category="sell">売</button>
            <button class="customer-tab" data-category="buy">買</button>
            <button class="customer-tab" data-category="investment">収益</button>
          </div>

          <!-- フィルターバー -->
          <div class="section-card" style="margin-bottom: 16px;">
            <div style="display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 13px; font-weight: 500;">年度:</label>
                <select class="filter-select" id="customerYear" style="min-width: 100px;"></select>
              </div>
              <select class="filter-select" id="customerStaffFilter">
                <option value="">担当者</option>
              </select>
              <select class="filter-select" id="customerStatusFilter">
                <option value="">ｽﾃｰﾀｽ</option>
              </select>
              <div class="date-range">
                <span class="date-icon">📅</span>
                <input type="date" class="date-input" id="customerDateFrom">
                <span class="date-separator">〜</span>
                <input type="date" class="date-input" id="customerDateTo">
              </div>
              <input type="text" class="search-input" id="customerKeyword" placeholder="ﾌﾘｰﾜｰﾄﾞ検索（氏名・住所・電話番号）" style="min-width: 250px;">
              <button class="btn btn-outline" id="btnCustomerReset">ﾘｾｯﾄ</button>
              <div style="margin-left: auto; display: flex; gap: 8px; align-items: center;">
                <select class="filter-select" id="customerPerPage" style="min-width: 80px;">
                  <option value="20">20件</option>
                  <option value="50">50件</option>
                  <option value="100">100件</option>
                  <option value="200">200件</option>
                </select>
                <button class="btn btn-primary" id="btnNewCustomer">新規顧客登録</button>
                <button class="btn btn-outline" id="btnReassignCaseNumbers" title="反響日順に案件番号を振り直します">採番し直す</button>
                <button class="btn btn-outline" id="btnExportCustomers">CSV出力</button>
                <button class="btn btn-outline" id="btnCustomerMasters">ﾏｽﾀｰ管理</button>
                <button class="btn btn-outline" id="btnCustomerStatusColors">ﾗﾍﾞﾙ色設定</button>
              </div>
            </div>
          </div>

          <!-- 顧客一覧テーブル -->
          <div class="section-card">
            <div class="customer-summary" id="customerSummary" style="margin-bottom: 12px; font-size: 13px; color: var(--gray-500);"></div>
            <div class="table-container">
              <table id="customersTable">
                <thead id="customersTableHead">
                  <!-- 動的に変更 -->
                </thead>
                <tbody id="customersBody"></tbody>
              </table>
            </div>
            <!-- ページネーション -->
            <div class="pagination" id="customerPagination" style="margin-top: 16px; display: flex; justify-content: center; gap: 8px;"></div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- 顧客登録・編集モーダル -->
  <div class="modal-backdrop hidden" id="modalCustomer">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modalCustomerTitle">新規顧客登録</h3>
        <button class="modal-close" data-close="modalCustomer">×</button>
      </div>
      <form id="customerForm">
        <input type="hidden" name="id">
        <input type="hidden" name="category" id="customerFormCategory">

        <!-- 共通フィールド -->
        <div class="form-grid">
          <div class="form-group"><label>案件番号</label><input name="case_number" readonly placeholder="自動採番"></div>
          <div class="form-group"><label>ｽﾃｰﾀｽ *</label>
            <select name="status" required>
              <option value="未対応">未対応</option>
              <option value="追客中">追客中</option>
              <option value="案内済">案内済</option>
              <option value="成約">成約</option>
            </select>
          </div>
          <div class="form-group"><label>担当者 *</label><select name="staff_id" id="customerFormStaff" required></select></div>
          <div class="form-group"><label>反響日 *</label><input type="date" name="inquiry_date" required></div>
          <div class="form-group"><label>反響 *</label>
            <select name="inquiry_source" required>
              <option value="">選択してください</option>
              <option value="アットホーム">ｱｯﾄﾎｰﾑ</option>
              <option value="スーモ">ｽｰﾓ</option>
              <option value="ホームズ">ﾎｰﾑｽﾞ</option>
              <option value="来店">来店</option>
              <option value="紹介">紹介</option>
              <option value="C21HP">C21HP</option>
              <option value="その他">その他</option>
            </select>
          </div>
          <div class="form-group"><label>連絡方法</label>
            <select name="contact_method">
              <option value="">選択してください</option>
              <option value="電話">電話</option>
              <option value="メール">ﾒｰﾙ</option>
              <option value="LINE">LINE</option>
              <option value="来店">来店</option>
            </select>
          </div>
          <div class="form-group"><label>種別 *</label>
            <select name="property_type" required>
              <option value="">選択してください</option>
              <option value="土地">土地</option>
              <option value="戸建">戸建</option>
              <option value="マンション">ﾏﾝｼｮﾝ</option>
              <option value="中古戸建">中古戸建</option>
              <option value="収益物件">収益物件</option>
              <option value="その他">その他</option>
            </select>
          </div>
          <div class="form-group"><label>氏名 *</label><input name="customer_name" required></div>
          <div class="form-group"><label>電話番号</label><input name="phone" type="tel"></div>
          <div class="form-group"><label>現住所</label><input name="current_address"></div>
          <div class="form-group"><label>ﾒｰﾙｱﾄﾞﾚｽ</label><input name="email" type="email"></div>
        </div>

        <!-- 売顧客専用フィールド -->
        <div id="sellFields" class="category-fields">
          <h4 style="margin: 16px 0 12px; font-size: 14px; color: var(--gray-700); border-bottom: 1px solid var(--gray-200); padding-bottom: 8px;">売顧客情報</h4>
          <div class="form-grid">
            <div class="form-group"><label>査定住所</label><input name="assessment_address"></div>
          </div>
          <h4 style="margin: 16px 0 12px; font-size: 14px; color: var(--gray-700);">進捗状況</h4>
          <div class="progress-grid">
            <label class="progress-item"><input type="checkbox" name="sell_first_call" value="済"><span>架電</span></label>
            <label class="progress-item"><input type="checkbox" name="call_status" value="済"><span>電話</span></label>
            <label class="progress-item"><input type="checkbox" name="mail_status" value="済"><span>ﾒｰﾙ</span></label>
            <label class="progress-item"><input type="checkbox" name="sms_status" value="済"><span>SMS</span></label>
            <label class="progress-item"><input type="checkbox" name="pre_assessment" value="済"><span>査定</span></label>
            <label class="progress-item"><input type="checkbox" name="mediation" value="済"><span>媒介</span></label>
            <label class="progress-item"><input type="checkbox" name="contract" value="済"><span>契約</span></label>
          </div>
        </div>

        <!-- 買顧客専用フィールド -->
        <div id="buyFields" class="category-fields hidden">
          <h4 style="margin: 16px 0 12px; font-size: 14px; color: var(--gray-700); border-bottom: 1px solid var(--gray-200); padding-bottom: 8px;">買顧客情報</h4>
          <div class="form-grid">
            <div class="form-group"><label>反響物件・価格</label><input name="target_property"></div>
          </div>
          <h4 style="margin: 16px 0 12px; font-size: 14px; color: var(--gray-700);">進捗状況</h4>
          <div class="progress-grid">
            <label class="progress-item"><input type="checkbox" name="buy_first_call" value="済"><span>架電</span></label>
            <label class="progress-item"><input type="checkbox" name="buy_call_status" value="済"><span>電話</span></label>
            <label class="progress-item"><input type="checkbox" name="buy_mail_status" value="済"><span>ﾒｰﾙ</span></label>
            <label class="progress-item"><input type="checkbox" name="showing_status" value="済"><span>案内</span></label>
            <label class="progress-item"><input type="checkbox" name="buy_contract" value="済"><span>契約</span></label>
          </div>
        </div>

        <!-- 収益顧客専用フィールド -->
        <div id="investmentFields" class="category-fields hidden">
          <h4 style="margin: 16px 0 12px; font-size: 14px; color: var(--gray-700); border-bottom: 1px solid var(--gray-200); padding-bottom: 8px;">収益顧客情報</h4>
          <div class="form-grid">
            <div class="form-group"><label>希望物件</label><input name="desired_property"></div>
            <div class="form-group"><label>利回り希望(%)</label><input name="yield_rate" type="number" step="0.1"></div>
            <div class="form-group"><label>想定家賃(月/円)</label><input name="expected_rent" type="number"></div>
            <div class="form-group"><label>自己資金(万円)</label><input name="own_funds" type="number"></div>
            <div class="form-group"><label>融資希望額(万円)</label><input name="loan_amount" type="number"></div>
            <div class="form-group"><label>希望ｴﾘｱ</label><input name="desired_area"></div>
          </div>
          <h4 style="margin: 16px 0 12px; font-size: 14px; color: var(--gray-700);">進捗状況</h4>
          <div class="progress-grid">
            <label class="progress-item"><input type="checkbox" name="inv_first_call" value="済"><span>架電</span></label>
            <label class="progress-item"><input type="checkbox" name="inv_call_status" value="済"><span>電話</span></label>
            <label class="progress-item"><input type="checkbox" name="inv_mail_status" value="済"><span>ﾒｰﾙ</span></label>
            <label class="progress-item"><input type="checkbox" name="inv_showing_status" value="済"><span>案内</span></label>
            <label class="progress-item"><input type="checkbox" name="inv_contract" value="済"><span>契約</span></label>
          </div>
        </div>

        <!-- ﾒﾓ -->
        <div class="form-group" style="margin-top: 16px;">
          <label>ﾒﾓ</label>
          <textarea name="memo" rows="3"></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-outline" id="btnEmailAnalysis">📧 ﾒｰﾙ分析</button>
          <button type="button" class="btn btn-outline" data-close="modalCustomer">ｷｬﾝｾﾙ</button>
          <button type="submit" class="btn btn-primary">保存する</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 反響ﾒｰﾙ分析モーダル -->
  <div class="modal-backdrop hidden" id="modalEmailAnalysis">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3 class="modal-title" id="modalEmailAnalysisTitle">📧 反響ﾒｰﾙ分析（売）</h3>
        <button class="modal-close" data-close="modalEmailAnalysis">×</button>
      </div>
      <div style="padding: 0 20px 20px;">
        <p style="font-size: 12px; color: var(--gray-500); margin: 0 0 12px;" id="emailAnalysisDesc">売反響ﾒｰﾙの本文を貼り付けると、顧客情報を自動抽出します。</p>
        <div class="form-group">
          <label>ﾒｰﾙ本文</label>
          <textarea id="emailAnalysisInput" rows="12" placeholder="反響ﾒｰﾙの本文をここに貼り付けてください...&#10;&#10;例:&#10;【ｽｰﾓ】新規お問い合わせがありました&#10;お名前: 山田 太郎&#10;電話番号: 090-1234-5678&#10;ﾒｰﾙ: yamada@example.com&#10;物件: 東京都渋谷区..."></textarea>
        </div>
        <div class="form-group" style="margin-top:12px;">
          <label>抽出結果ﾌﾟﾚﾋﾞｭｰ</label>
          <div id="emailAnalysisResult" style="background:#f9fafb;border:1px solid var(--gray-200);border-radius:8px;padding:12px;min-height:100px;font-size:12px;">
            <span style="color:var(--gray-400);">ﾒｰﾙ本文を入力すると、ここに抽出結果が表示されます</span>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" data-close="modalEmailAnalysis">ｷｬﾝｾﾙ</button>
          <button type="button" class="btn btn-primary" id="btnApplyEmailAnalysis">ﾌｫｰﾑに反映</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 顧客詳細モーダル -->
  <div class="modal-backdrop hidden" id="modalCustomerDetail">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">顧客詳細</h3>
        <button class="modal-close" data-close="modalCustomerDetail">×</button>
      </div>
      <div class="modal-body" id="customerDetailBody">
        <!-- 動的に表示 -->
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" data-close="modalCustomerDetail">閉じる</button>
        <button type="button" class="btn btn-primary" id="btnEditCustomerFromDetail">編集</button>
        <button type="button" class="btn btn-danger" id="btnDeleteCustomerFromDetail">削除</button>
      </div>
    </div>
  </div>

  <!-- 顧客管理マスター設定モーダル -->
  <div class="modal-backdrop hidden" id="modalCustomerMasters">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">顧客管理ﾏｽﾀｰ設定</h3>
        <button class="modal-close" data-close="modalCustomerMasters">×</button>
      </div>
      <form id="customerMastersForm">
        <p style="font-size: 12px; color: var(--gray-500); margin: 0 0 16px;">各項目をｶﾝﾏ区切りで入力してください</p>
        <div class="form-grid">
          <div class="form-group">
            <label>反響（売）</label>
            <textarea name="inquiry_source_sell" rows="3" placeholder="ｽｰﾓ, ｱｯﾄﾎｰﾑ, ..."></textarea>
          </div>
          <div class="form-group">
            <label>反響（買）</label>
            <textarea name="inquiry_source_buy" rows="3" placeholder="ｽｰﾓ, ｱｯﾄﾎｰﾑ, ..."></textarea>
          </div>
          <div class="form-group">
            <label>ｽﾃｰﾀｽ（売）</label>
            <textarea name="status_sell" rows="2" placeholder="対応中, 媒介中, ..."></textarea>
          </div>
          <div class="form-group">
            <label>ｽﾃｰﾀｽ（買）</label>
            <textarea name="status_buy" rows="2" placeholder="対応中, 成約済, ..."></textarea>
          </div>
          <div class="form-group">
            <label>種別</label>
            <textarea name="property_type" rows="2" placeholder="戸建て, ﾏﾝｼｮﾝ, 土地, ..."></textarea>
          </div>
          <div class="form-group">
            <label>連絡方法</label>
            <textarea name="contact_method" rows="2" placeholder="ﾒｰﾙ, 電話, SMS"></textarea>
          </div>
          <div class="form-group">
            <label>担当者</label>
            <textarea name="staff" rows="2" placeholder="担当者名, ..."></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" onclick="openCustomerStatusColorsModal()">ﾗﾍﾞﾙ色設定</button>
          <button type="button" class="btn btn-outline" data-close="modalCustomerMasters">ｷｬﾝｾﾙ</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 顧客ステータス色設定モーダル -->
  <div class="modal-backdrop hidden" id="modalCustomerStatusColors">
    <div class="modal" style="max-width: 620px;">
      <div class="modal-header">
        <h3 class="modal-title">顧客ｽﾃｰﾀｽ色設定</h3>
        <button class="modal-close" data-close="modalCustomerStatusColors">×</button>
      </div>
      <form id="customerStatusColorsForm">
        <p class="stats-subtitle">各ｽﾃｰﾀｽの背景色と文字色を設定できます。</p>
        <div class="table-container" style="max-height: 360px; overflow-y: auto;">
          <table>
            <thead>
              <tr>
                <th style="width:40%">ｽﾃｰﾀｽ</th>
                <th style="width:25%">背景色</th>
                <th style="width:25%">文字色</th>
                <th style="width:10%">ﾌﾟﾚﾋﾞｭｰ</th>
              </tr>
            </thead>
            <tbody id="customerStatusColorsBody"></tbody>
          </table>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" data-close="modalCustomerStatusColors">ｷｬﾝｾﾙ</button>
          <button type="submit" class="btn btn-primary">保存する</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 新規登録・編集モーダル -->
  <div class="modal-backdrop hidden" id="modalContract">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalContractTitle">新規媒介登録</h3>
        <button class="modal-close" data-close="modalContract">×</button>
      </div>
      <form id="contractForm">
        <div class="form-grid">
          <div class="form-group"><label>媒介No. *</label><input name="id" required></div>
          <div class="form-group"><label>担当 *</label><select name="staff" required id="formStaff"></select></div>
          <div class="form-group"><label>種別 *</label><select name="type" required id="formType"></select></div>
          <div class="form-group"><label>物件種別</label><select name="propertyType" id="formPropertyType"></select></div>
          <div class="form-group"><label>物件所在地（市町村から）</label><input name="address"></div>
          <div class="form-group"><label>売主</label><input name="owner"></div>
          <div class="form-group"><label>売主住所</label><input name="ownerAddress"></div>
          <div class="form-group"><label>売主連絡先</label><input name="ownerContact"></div>
          <div class="form-group"><label>初回媒介日</label><input type="date" name="signedDate"></div>
          <div class="form-group"><label>媒介期日</label><input type="date" name="expireDate"></div>
          <div class="form-group"><label>媒介価格 (万円)</label><input type="number" name="price" min="0" step="1"></div>
          <div class="form-group"><label>レインズ登録フラグ</label><select name="reinsFlag" id="formReinsFlag"><option value="true">登録済み</option><option value="false">未登録</option></select></div>
          <div class="form-group"><label>レインズ満了日</label><input type="date" name="reinsExpire"></div>
          <div class="form-group"><label>反響媒体</label><select name="media" id="formMedia"></select></div>
          <div class="form-group"><label>現況</label><select name="condition" id="formCondition"></select></div>
          <div class="form-group"><label>鍵の場所</label><select name="keyLocation" id="formKeyLocation"></select></div>
          <div class="form-group" id="keyBoxNumberGroup" style="display:none;"><label>ｷｰﾎﾞｯｸｽ番号</label><input name="keyBoxNumber"></div>
          <div class="form-group"><label>取引状況</label><select name="status" id="formStatus"></select></div>
        </div>
        <!-- 申込あり時の追加項目 -->
        <div id="offerSection" style="display:none; margin-top:12px; padding:12px; background:#fffbeb; border-radius:8px; border:1px solid #fcd34d;">
          <p style="margin:0 0 12px; font-weight:600; color:#92400e;">📝 申込情報</p>
          <div class="form-grid">
            <div class="form-group"><label>申込日</label><input type="date" name="offerDate"></div>
            <div class="form-group"><label>レインズ変更済み</label><select name="reinsChanged" id="formReinsChanged"><option value="false">未変更</option><option value="true">変更済み</option></select></div>
            <div class="form-group"><label>レインズ変更日</label><input type="date" name="reinsChangeDate" id="formReinsChangeDate" disabled></div>
          </div>
        </div>
        <!-- 成約情報（成約時のみ表示） -->
        <div id="closeInfoSection" style="display:none; margin-top:12px; padding:12px; background:#ecfdf5; border-radius:8px; border:1px solid #10b981;">
          <p style="margin:0 0 12px; font-weight:600; color:#065f46;">✅ 成約情報</p>
          <div class="form-grid">
            <div class="form-group"><label>成約日</label><input type="date" name="closeDate"></div>
            <div class="form-group"><label>成約価格 (万円)</label><input type="number" name="closePrice" min="0" step="1"></div>
            <div class="form-group"><label>取引形態</label><select name="dealType"><option value="">選択</option><option value="両手">両手</option><option value="片手（売側）">片手（売側）</option><option value="片手（買側）">片手（買側）</option></select></div>
            <div class="form-group"><label>成約登録日</label><input type="date" name="closeRegDate"></div>
          </div>
        </div>
        <!-- 中止情報（中止時のみ表示） -->
        <div id="cancelInfoSection" style="display:none; margin-top:12px; padding:12px; background:#f3f4f6; border-radius:8px; border:1px solid #9ca3af;">
          <p style="margin:0 0 12px; font-weight:600; color:#374151;">⛔ 中止情報</p>
          <div class="form-grid">
            <div class="form-group"><label>中止日</label><input type="date" name="cancelDate"></div>
            <div class="form-group"><label>レインズ削除済み</label><select name="reinsDeleted"><option value="false">未削除</option><option value="true">削除済み</option></select></div>
            <div class="form-group"><label>中止理由</label><input name="cancelReason"></div>
          </div>
        </div>
        <div class="form-group" style="margin-top:12px;"><label>備考</label><textarea name="memo"></textarea></div>
        <div class="modal-actions" id="contractModalActions">
          <div id="editActionButtons" class="hidden" style="display:flex; gap:6px; flex-wrap:wrap;">
            <button type="button" class="btn btn-outline" data-edit-action="renew">更新</button>
            <button type="button" class="btn btn-outline" data-edit-action="change">変更</button>
            <button type="button" class="btn btn-outline" data-edit-action="close">成約</button>
            <button type="button" class="btn btn-outline" data-edit-action="purchase">買取</button>
            <button type="button" class="btn btn-outline" data-edit-action="cancel">中止</button>
            <button type="button" class="btn btn-outline" data-edit-action="delete">削除</button>
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-left:auto;">
            <button type="button" class="btn btn-outline" data-close="modalContract">キャンセル</button>
            <button type="submit" class="btn btn-primary" id="contractSubmit">保存する</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- ユーザー一覧モーダル -->
  <div class="modal-backdrop hidden" id="modalUserList">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">👥 ユーザー一覧</h3>
        <button class="modal-close" data-close="modalUserList">×</button>
      </div>
      <div class="modal-body">
        <table style="width: 100%; font-size: 13px;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 8px; border-bottom: 2px solid var(--gray-200);">ログインID</th>
              <th style="text-align: left; padding: 8px; border-bottom: 2px solid var(--gray-200);">表示名（担当者名）</th>
              <th style="text-align: center; padding: 8px; border-bottom: 2px solid var(--gray-200);">権限</th>
            </tr>
          </thead>
          <tbody id="userListBody"></tbody>
        </table>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" data-close="modalUserList">閉じる</button>
      </div>
    </div>
  </div>

  <!-- パスワード変更モーダル -->
  <div class="modal-backdrop hidden" id="modalChangePassword">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">🔑 パスワード変更</h3>
        <button class="modal-close" data-close="modalChangePassword">×</button>
      </div>
      <div class="modal-body">
        <p style="margin: 0 0 16px; font-size: 13px; color: var(--gray-500);">
          パスワードの変更は<strong>config.env</strong>ファイルを直接編集してください。
        </p>
        <div style="background: var(--gray-100); padding: 12px; border-radius: 6px; font-size: 12px; font-family: monospace;">
          <p style="margin: 0 0 8px; font-weight: 600;">ファイルの場所:</p>
          <code>C:\媒介契約管理システム\config.env</code>
          <p style="margin: 12px 0 8px 0; font-weight: 600;">書式:</p>
          <code>USER_1=ログインID:パスワード:表示名</code>
        </div>
        <p style="margin: 16px 0 0; font-size: 12px; color: var(--warning-color);">
          ⚠️ 変更後はサーバーを再起動してください
        </p>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-primary" data-close="modalChangePassword">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 媒介更新モーダル -->
  <div class="modal-backdrop hidden" id="modalUpdate">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">媒介契約更新</h3>
        <button class="modal-close" data-close="modalUpdate">×</button>
      </div>
      <form id="updateForm">
        <div class="form-grid">
          <div class="form-group"><label>媒介No.</label><input name="id" readonly></div>
          <div class="form-group"><label>物件名 / 所在地</label><input name="address" readonly></div>
          <div class="form-group"><label>現在の有効期限</label><input name="currentExpire" readonly></div>
          <div class="form-group"><label>新しい有効期限</label><input type="date" name="newExpire"></div>
          <div class="form-group"><label>新しいレインズ満了日</label><input type="date" name="newReinsExpire"></div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" data-close="modalUpdate">キャンセル</button>
          <button type="submit" class="btn btn-primary">更新する</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 条件変更モーダル -->
  <div class="modal-backdrop hidden" id="modalChange">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">契約条件変更</h3>
        <button class="modal-close" data-close="modalChange">×</button>
      </div>
      <form id="changeForm">
        <div class="form-grid">
          <div class="form-group"><label>媒介No.</label><input name="id" readonly></div>
          <div class="form-group"><label>物件名 / 所在地</label><input name="address" readonly></div>
          <div class="form-group"><label>媒介価格</label><input name="currentPrice" readonly></div>
          <div class="form-group"><label>新しい媒介価格 (万円)</label><input type="number" name="newPrice" min="0" step="1" required></div>
          <div class="form-group"><label>変更日 *</label><input type="date" name="changeDate" required></div>
          <div class="form-group"><label class="form-checkbox"><input type="checkbox" id="changeReinsToggle"> <span>レインズ満了日も変更する</span></label></div>
          <div class="form-group"><label>新しいレインズ満了日</label><input type="date" name="newReinsExpire" id="changeReinsDate" disabled></div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" data-close="modalChange">キャンセル</button>
          <button type="submit" class="btn btn-primary">変更を保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 買取登録モーダル -->
  <div class="modal-backdrop hidden" id="modalPurchase">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">買取登録</h3>
        <button class="modal-close" data-close="modalPurchase">×</button>
      </div>
      <form id="purchaseForm">
        <div class="form-grid">
          <div class="form-group"><label>媒介No.</label><input name="id" readonly></div>
          <div class="form-group"><label>物件名 / 所在地</label><input name="address" readonly></div>
          <div class="form-group"><label>買取日 *</label><input type="date" name="purchaseDate" required></div>
          <div class="form-group"><label>買取価格 (万円) *</label><input type="number" name="purchasePrice" min="0" step="1" required></div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" data-close="modalPurchase">キャンセル</button>
          <button type="submit" class="btn btn-primary">登録する</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 直接買取登録モーダル -->
  <div class="modal-backdrop hidden" id="modalNewPurchase">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">新規買取登録（媒介なし）</h3>
        <button class="modal-close" data-close="modalNewPurchase">×</button>
      </div>
      <form id="newPurchaseForm">
        <div class="form-grid">
          <div class="form-group"><label>買取日 *</label><input type="date" name="purchaseDate" required></div>
          <div class="form-group">
            <label>担当 *</label>
            <select name="staff" id="formPurchaseStaff" required></select>
          </div>
          <div class="form-group"><label>物件所在地（市町村から）</label><input name="address" placeholder="例）横浜市中区?"></div>
          <div class="form-group"><label>買取価格 (万円) *</label><input type="number" name="price" min="0" step="1" required></div>
          <div class="form-group" style="grid-column: 1 / -1;">
            <label>備考</label>
            <textarea name="memo" rows="2" placeholder="メモがあれば入力"></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" data-close="modalNewPurchase">キャンセル</button>
          <button type="submit" class="btn btn-primary">買取を登録</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 成約モーダル -->
  <div class="modal-backdrop hidden" id="modalClose">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">成約登録</h3>
        <button class="modal-close" data-close="modalClose">×</button>
      </div>
      <form id="closeForm">
        <div class="form-grid">
          <div class="form-group"><label>媒介No.</label><input name="id" readonly></div>
          <div class="form-group"><label>物件名 / 所在地</label><input name="address" readonly></div>
          <div class="form-group"><label>成約日 *</label><input type="date" name="closeDate" required></div>
          <div class="form-group"><label>成約価格 (万円) *</label><input type="number" name="closePrice" min="0" step="1" required></div>
          <div class="form-group"><label>取引形態 *</label><select name="dealType" required><option value="仲介">仲介</option><option value="代理">代理</option></select></div>
          <div class="form-group"><label>成約登録日 *</label><input type="date" name="closeRegDate" required></div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" data-close="modalClose">キャンセル</button>
          <button type="submit" class="btn btn-primary">登録する</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 中止モーダル -->
  <div class="modal-backdrop hidden" id="modalCancel">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">中止登録</h3>
        <button class="modal-close" data-close="modalCancel">×</button>
      </div>
      <form id="cancelForm">
        <div class="form-grid">
          <div class="form-group"><label>媒介No.</label><input name="id" readonly></div>
          <div class="form-group"><label>物件名 / 所在地</label><input name="address" readonly></div>
          <div class="form-group"><label>中止日 *</label><input type="date" name="cancelDate" required></div>
          <div class="form-group"><label>レインズ削除済み</label><select name="reinsDeleted"><option value="true">はい</option><option value="false">いいえ</option></select></div>
        </div>
        <div class="form-group"><label>中止理由</label><textarea name="cancelReason"></textarea></div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" data-close="modalCancel">キャンセル</button>
          <button type="submit" class="btn btn-primary">中止する</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 通知モーダル（ログイン時ポップアップ） -->
  <div class="modal-backdrop hidden" id="modalNotifications">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">🔔 お知らせ</h3>
        <button class="modal-close" data-close="modalNotifications">×</button>
      </div>
      <div class="modal-body" style="max-height: 500px; overflow-y: auto;">
        <div id="notificationModalContent"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" id="btnEnableBrowserNotification">🔔 ブラウザ通知を許可</button>
        <button type="button" class="btn btn-primary" data-close="modalNotifications">確認しました</button>
      </div>
    </div>
  </div>

  <!-- 期限アラートモーダル -->
  <div class="modal-backdrop hidden" id="modalAlertDetail">
    <div class="modal" style="max-width: 860px;">
      <div class="modal-header">
        <h3 class="modal-title">期限が近い案件</h3>
        <button class="modal-close" data-close="modalAlertDetail">×</button>
      </div>
      <div class="modal-body">
        <p class="stats-subtitle" style="margin: 0 0 12px 0;">14日以内に期限が来る案件を表示しています。</p>
        <div class="table-container" style="max-height: 360px; overflow-y: auto;">
          <table>
            <thead>
              <tr>
                <th>媒介No.</th>
                <th>担当</th>
                <th>取引状況</th>
                <th>媒介期日</th>
                <th>残日数</th>
                <th>物件所在地（市町村から）</th>
              </tr>
            </thead>
            <tbody id="alertModalBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" data-close="modalAlertDetail">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 月次推移モーダル -->
  <div class="modal-backdrop hidden" id="modalMonthlyTrend">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">月次推移</h3>
        <button class="modal-close" data-close="modalMonthlyTrend">×</button>
      </div>
      <div class="modal-body">
        <p class="stats-subtitle" style="margin: 0 0 12px 0;">最古の月から最新までの件数を表示します。</p>
        <div class="table-container" style="max-height: 360px; overflow-y: auto;">
          <table>
            <thead>
              <tr>
                <th>月</th>
                <th>当月</th>
                <th>成約</th>
                <th>買取</th>
                <th>中止</th>
                <th>在庫</th>
              </tr>
            </thead>
            <tbody id="monthlyTrendBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" data-close="modalMonthlyTrend">閉じる</button>
      </div>
    </div>
  </div>

  <!-- CSVエクスポートモーダル -->
  <div class="modal-backdrop hidden" id="modalExport">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3 class="modal-title">CSV出力</h3>
        <button class="modal-close" data-close="modalExport">×</button>
      </div>
      <div class="modal-body">
        <p style="margin: 0 0 16px; font-size: 13px; color: var(--gray-500);">出力範囲を選択してください</p>
        <div style="display: flex; flex-direction: column; gap: 12px;">
          <button class="btn btn-primary" id="btnExportFiltered" style="width: 100%;">現在の表示結果を出力</button>
          <button class="btn btn-outline" id="btnExportAll" style="width: 100%;">全件を出力</button>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" data-close="modalExport">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- 価格推移モーダル -->
  <div class="modal-backdrop hidden" id="modalPriceHistory">
    <div class="modal" style="max-width: 500px;">
      <div class="modal-header">
        <h3 class="modal-title">価格推移</h3>
        <button class="modal-close" data-close="modalPriceHistory">×</button>
      </div>
      <div class="modal-body">
        <p style="margin: 0 0 12px; font-size: 13px; color: var(--gray-500);">媒介No.: <span id="priceHistoryId">-</span></p>
        <table style="width: 100%; font-size: 13px;">
          <thead>
            <tr>
              <th style="text-align: left; padding: 8px; border-bottom: 2px solid var(--gray-200);">日付</th>
              <th style="text-align: right; padding: 8px; border-bottom: 2px solid var(--gray-200);">価格</th>
            </tr>
          </thead>
          <tbody id="priceHistoryBody"></tbody>
        </table>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" data-close="modalPriceHistory">閉じる</button>
      </div>
    </div>
  </div>

  <!-- バックアップ管理モーダル -->
  <div class="modal-backdrop hidden" id="modalBackup">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">バックアップ管理</h3>
        <button class="modal-close" data-close="modalBackup">×</button>
      </div>
      <div class="modal-body">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <p style="margin: 0; font-size: 13px; color: var(--gray-500);">バックアップは起動時と1時間ごとに自動実行されます</p>
          <button class="btn btn-primary" id="btnRunBackup">今すぐバックアップ</button>
        </div>
        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
          <table>
            <thead>
              <tr>
                <th>バックアップ日時</th>
                <th>保存先</th>
                <th>フォルダ名</th>
              </tr>
            </thead>
            <tbody id="backupListBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" data-close="modalBackup">閉じる</button>
      </div>
    </div>
  </div>

  <!-- ロック管理モーダル -->
  <div class="modal-backdrop hidden" id="modalLocks">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">ロック管理</h3>
        <button class="modal-close" data-close="modalLocks">×</button>
      </div>
      <div class="modal-body">
        <p class="stats-subtitle" style="margin: 0 0 12px; color: var(--gray-600);">手動解除が必要なロックを解除できます。</p>
        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
          <table>
            <thead>
              <tr>
                <th>媒介No.</th>
                <th>ユーザー</th>
                <th>ロック日時</th>
                <th>有効期限</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="lockListBody"></tbody>
          </table>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn btn-outline" data-close="modalLocks">閉じる</button>
      </div>
    </div>
  </div>

  <!-- マスター管理 -->
  <div class="modal-backdrop hidden" id="modalMasters">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">マスター管理</h3>
        <button class="modal-close" data-close="modalMasters">×</button>
      </div>
      <form id="mastersForm">
        <p class="stats-title">カンマ区切りで編集できます</p>
        <div class="form-group"><label>種別</label><textarea name="種別"></textarea></div>
        <div class="form-group"><label>物件</label><textarea name="物件"></textarea></div>
        <div class="form-group"><label>担当</label><textarea name="担当"></textarea></div>
        <div class="form-group"><label>反響媒体</label><textarea name="反響媒体"></textarea></div>
        <div class="form-group"><label>現況</label><textarea name="現況"></textarea></div>
        <div class="form-group"><label>鍵の場所</label><textarea name="鍵の場所"></textarea></div>
        <div class="form-group"><label>取引状況</label><textarea name="取引状況"></textarea></div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" data-close="modalMasters">キャンセル</button>
          <button type="submit" class="btn btn-primary">保存</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ステータス色設定 -->
  <div class="modal-backdrop hidden" id="modalStatusColors">
    <div class="modal" style="max-width: 620px;">
      <div class="modal-header">
        <h3 class="modal-title">ステータス色設定</h3>
        <button class="modal-close" data-close="modalStatusColors">×</button>
      </div>
      <form id="statusColorsForm">
        <p class="stats-subtitle">各ステータスの背景色と文字色を設定できます。</p>
        <div class="table-container" style="max-height: 360px; overflow-y: auto;">
          <table>
            <thead>
              <tr>
                <th>ステータス</th>
                <th>背景色</th>
                <th>文字色</th>
              </tr>
            </thead>
            <tbody id="statusColorsBody"></tbody>
          </table>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-outline" data-close="modalStatusColors">キャンセル</button>
          <button type="submit" class="btn btn-primary">保存する</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    const K = {
      staff: "担当",
      type: "種別",
      status: "取引状況",
      statusDate: "ステータス日付",
      signedDate: "新規媒介締結日",
      expireDate: "媒介期日",
      propertyType: "物件種別",
      address: "物件所在地",
      price: "現在の媒介価格",
      priceHistory: "価格推移",
      owner: "売主",
      ownerAddress: "売主住所",
      ownerContact: "売主連絡先",
      reinsFlag: "レインズ登録フラグ",
      reinsExpire: "レインズ満了日",
      media: "反響媒体",
      memo: "備考",
      condition: "現況",
      keyLocation: "鍵の場所",
      keyBoxNumber: "キーボックス番号",
      offerDate: "申込日",
      reinsChanged: "レインズ変更済み",
      reinsChangeDate: "レインズ変更日",
      closeInfo: "成約情報",
      purchaseInfo: "買取情報",
      cancelInfo: "中止理由",
    };

    const STATUS_STYLES = {
      "公開中": { bg: "#dbeafe", color: "#1e40af" },
      "書面による購入申込みあり": { bg: "#fef3c7", color: "#92400e" },
      "売主都合で一時紹介停止中": { bg: "#fee2e2", color: "#991b1b" },
      "成約": { bg: "#d1fae5", color: "#065f46" },
      "買取": { bg: "#ede9fe", color: "#6b21a8" },
      "中止": { bg: "#e5e7eb", color: "#374151" },
    };

    const KEYBOX_LABEL = "ｷｰﾎﾞｯｸｽ";
    const KEYBOX_OLD_LABEL = "キーボックス";

    const state = {
      masters: {},
      contracts: [],
      closed: [],
      summary: [],
      includeStaff: [],
      staffOrder: [],
      notifications: [],
      statusColors: {},
      goals: { storeTarget: 0, staffTargets: {}, includeStaff: [] },
      currentUser: null,
      loginId: null,
      filters: { staff: "", status: "", from: "", to: "", query: "", closedOnly: false },
      sort: { key: "signedDate", dir: "desc" },
      editingId: null,
      chart: null,
    };

    const el = (id) => document.getElementById(id);

    function renderStatusBadge(status) {
      const style = (state.statusColors && state.statusColors[status]) || STATUS_STYLES[status] || { bg: "var(--gray-200)", color: "var(--gray-700)" };
      const text = status || "-";
      return `<span class="badge" style="background:${style.bg};color:${style.color};">${text}</span>`;
    }

    const isKeyBox = (val) => val === KEYBOX_LABEL || val === KEYBOX_OLD_LABEL;
    const normalizeKeyLocation = (val) => isKeyBox(val) ? KEYBOX_LABEL : val;
    const HALF_KANA_MAP = {
      "ァ": "ｧ", "ア": "ｱ", "ィ": "ｨ", "イ": "ｲ", "ゥ": "ｩ", "ウ": "ｳ", "ェ": "ｪ", "エ": "ｴ", "ォ": "ｫ", "オ": "ｵ",
      "カ": "ｶ", "ガ": "ｶﾞ", "キ": "ｷ", "ギ": "ｷﾞ", "ク": "ｸ", "グ": "ｸﾞ", "ケ": "ｹ", "ゲ": "ｹﾞ", "コ": "ｺ", "ゴ": "ｺﾞ",
      "サ": "ｻ", "ザ": "ｻﾞ", "シ": "ｼ", "ジ": "ｼﾞ", "ス": "ｽ", "ズ": "ｽﾞ", "セ": "ｾ", "ゼ": "ｾﾞ", "ソ": "ｿ", "ゾ": "ｿﾞ",
      "タ": "ﾀ", "ダ": "ﾀﾞ", "チ": "ﾁ", "ヂ": "ﾁﾞ", "ッ": "ｯ", "ツ": "ﾂ", "ヅ": "ﾂﾞ", "テ": "ﾃ", "デ": "ﾃﾞ", "ト": "ﾄ", "ド": "ﾄﾞ",
      "ナ": "ﾅ", "ニ": "ﾆ", "ヌ": "ﾇ", "ネ": "ﾈ", "ノ": "ﾉ",
      "ハ": "ﾊ", "バ": "ﾊﾞ", "パ": "ﾊﾟ", "ヒ": "ﾋ", "ビ": "ﾋﾞ", "ピ": "ﾋﾟ", "フ": "ﾌ", "ブ": "ﾌﾞ", "プ": "ﾌﾟ", "ヘ": "ﾍ", "ベ": "ﾍﾞ", "ペ": "ﾍﾟ", "ホ": "ﾎ", "ボ": "ﾎﾞ", "ポ": "ﾎﾟ",
      "マ": "ﾏ", "ミ": "ﾐ", "ム": "ﾑ", "メ": "ﾒ", "モ": "ﾓ",
      "ャ": "ｬ", "ヤ": "ﾔ", "ュ": "ｭ", "ユ": "ﾕ", "ョ": "ｮ", "ヨ": "ﾖ",
      "ラ": "ﾗ", "リ": "ﾘ", "ル": "ﾙ", "レ": "ﾚ", "ロ": "ﾛ",
      "ワ": "ﾜ", "ヲ": "ｦ", "ン": "ﾝ", "ヴ": "ｳﾞ", "ヰ": "ｲ", "ヱ": "ｴ", "ヮ": "ﾜ",
      "ー": "ｰ", "。": "｡", "、": "､", "・": "･", "「": "｢", "」": "｣", "゛": "ﾞ", "゜": "ﾟ", "ヵ": "ｶ", "ヶ": "ｹ"
    };
    const toHalfKana = (text) => text ? String(text).replace(/[\u30A1-\u30FA\u30FD-\u30FE\u30FC\u309B\u309C]/g, (ch) => HALF_KANA_MAP[ch] || ch) : text;

    document.addEventListener("DOMContentLoaded", () => {
      bindGlobalEvents();
      checkAuth();
    });

    function bindGlobalEvents() {
      el("sidebarToggle").addEventListener("click", toggleSidebar);
      el("logoutBtn").addEventListener("click", logout);
      el("btnNewContract").addEventListener("click", () => openContractModal());
      el("btnNewPurchase").addEventListener("click", openNewPurchaseModal);
      el("btnDeadlineView").addEventListener("click", () => alert("期限カレンダーは現在の表を基に確認してください。"));
      el("btnShowClosed").addEventListener("click", toggleClosedView);
      el("btnMasters").addEventListener("click", openMastersModal);
      el("btnStatusColors").addEventListener("click", openStatusColorsModal);
      el("btnLockManage").addEventListener("click", openLockModal);
      el("btnLockManageTop").addEventListener("click", openLockModal);
      el("alertDetailBtn").addEventListener("click", renderAlertDetailModal);
      el("btnMonthlyTrend").addEventListener("click", renderMonthlyTrendModal);
      el("loginForm").addEventListener("submit", handleLogin);
      el("contractForm").addEventListener("submit", submitContract);
      el("updateForm").addEventListener("submit", submitUpdate);
      el("changeForm").addEventListener("submit", submitChange);
      el("purchaseForm").addEventListener("submit", submitPurchase);
      el("closeForm").addEventListener("submit", submitClose);
      el("cancelForm").addEventListener("submit", submitCancel);
      el("newPurchaseForm").addEventListener("submit", submitNewPurchase);
      el("mastersForm").addEventListener("submit", submitMasters);
      el("statusColorsForm").addEventListener("submit", submitStatusColors);
      el("changeReinsToggle").addEventListener("change", (e) => {
        const target = el("changeReinsDate");
        target.disabled = !e.target.checked;
        if (!e.target.checked) target.value = "";
      });

      const openGoalBtn = el("btnOpenGoalSettings");
      if (openGoalBtn) openGoalBtn.addEventListener("click", () => { activateMenu("settings"); showPage("settings"); });
      const saveGoalsBtn = el("btnSaveGoals");
      if (saveGoalsBtn) saveGoalsBtn.addEventListener("click", saveGoals);
      
      // 鍵の場所：ｷｰﾎﾞｯｸｽ選択時に番号入力欄を表示
      el("formKeyLocation").addEventListener("change", (e) => {
        const keyBoxGroup = el("keyBoxNumberGroup");
        if (isKeyBox(e.target.value)) {
          keyBoxGroup.style.display = "block";
        } else {
          keyBoxGroup.style.display = "none";
          el("contractForm").elements["keyBoxNumber"].value = "";
        }
      });
      
      // 取引状況：選択に応じて追加情報欄を表示
      el("formStatus").addEventListener("change", (e) => {
        const status = e.target.value;
        el("offerSection").style.display = status === "書面による購入申込みあり" ? "block" : "none";
        el("closeInfoSection").style.display = status === "成約" ? "block" : "none";
        el("cancelInfoSection").style.display = status === "中止" ? "block" : "none";
      });
      
      // レインズ変更済み選択時に変更日入力を有効化
      el("formReinsChanged").addEventListener("change", (e) => {
        const changeDateInput = el("formReinsChangeDate");
        if (e.target.value === "true") {
          changeDateInput.disabled = false;
        } else {
          changeDateInput.disabled = true;
          changeDateInput.value = "";
        }
      });
      
      el("btnNewContract2").addEventListener("click", () => openContractModal());
      el("btnBackupManage").addEventListener("click", openBackupModal);
      el("btnRunBackup").addEventListener("click", runBackup);
      
      // CSVエクスポートボタン
      el("btnExportDashboard").addEventListener("click", () => openExportModal("dashboard"));
      el("btnExportDeadline").addEventListener("click", () => openExportModal("deadline"));
      el("btnExportClosed").addEventListener("click", () => openExportModal("closed"));
      el("btnExportByStaff").addEventListener("click", () => openExportModal("byStaff"));
      el("btnExportFiltered").addEventListener("click", () => executeExport(false));
      el("btnExportAll").addEventListener("click", () => executeExport(true));
      
      // 通知関連
      el("notificationBtn").addEventListener("click", toggleNotificationDropdown);
      el("clearAllNotifications").addEventListener("click", clearAllNotifications);
      el("btnEnableBrowserNotification").addEventListener("click", requestBrowserNotificationPermission);
      document.addEventListener("click", (e) => {
        const wrapper = document.querySelector(".notification-wrapper");
        if (!wrapper.contains(e.target)) {
          el("notificationDropdown").classList.add("hidden");
        }
      });
      
      // ユーザー関連
      el("userBtn").addEventListener("click", toggleUserDropdown);
      el("btnChangePassword").addEventListener("click", () => { el("userDropdown").classList.add("hidden"); openModal("modalChangePassword"); });
      el("btnUserList").addEventListener("click", () => { el("userDropdown").classList.add("hidden"); openUserListModal(); });
      document.addEventListener("click", (e) => {
        const wrapper = document.querySelector(".user-wrapper");
        if (!wrapper.contains(e.target)) {
          el("userDropdown").classList.add("hidden");
        }
      });

      document.querySelectorAll(".sidebar .menu-item").forEach((item) => {
        item.addEventListener("click", () => {
          if (item.classList.contains("disabled")) return;
          document.querySelectorAll(".sidebar .menu-item").forEach((i) => i.classList.remove("active"));
          item.classList.add("active");
          showPage(item.dataset.page);
        });
      });

      ["filterStaff", "filterStatus", "dateFrom", "dateTo", "searchInput"].forEach((id) => {
        el(id).addEventListener("input", () => {
          state.filters.staff = el("filterStaff").value;
          state.filters.status = el("filterStatus").value;
          state.filters.from = el("dateFrom").value;
          state.filters.to = el("dateTo").value;
          state.filters.query = el("searchInput").value.trim();
          renderTable();
          renderAlert();
        });
      });

      document.querySelectorAll("th.sortable").forEach((th) => {
        th.addEventListener("click", () => {
          const key = th.dataset.key;
          if (state.sort.key === key) {
            state.sort.dir = state.sort.dir === "asc" ? "desc" : "asc";
          } else {
            state.sort.key = key;
            state.sort.dir = "asc";
          }
          renderTable();
        });
      });

      ["closedSearchContracted", "closedSearchPurchased", "closedSearchCanceled"].forEach((id) => {
        const input = el(id);
        if (input) input.addEventListener("input", renderClosedTable);
      });

      document.querySelectorAll("[data-edit-action]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const action = btn.dataset.editAction;
          const id = state.editingId;
          if (!id) return;
          closeModal("modalContract");
          handleRowAction(action, id);
        });
      });

      document.querySelectorAll(".modal-close, [data-close]").forEach((btn) => {
        btn.addEventListener("click", () => closeModal(btn.dataset.close || ""));
      });
    }

    function toggleSidebar() { el("sidebar").classList.toggle("open"); }

    async function checkAuth() {
      try {
        const res = await fetch("/api/check-auth", { credentials: "include" });
        if (res.ok) {
          const data = await res.json();
          if (data.authenticated) { enterApp(data.user_id, data.login_id); return; }
        }
      } catch (err) { console.error(err); }
      showLogin();
    }

    function showLogin() {
      el("loginView").classList.remove("hidden");
      el("app").classList.add("hidden");
    }

    function activateMenu(page) {
      document.querySelectorAll(".sidebar .menu-item").forEach((i) => {
        if (!i.dataset.page) return;
        i.classList.toggle("active", i.dataset.page === page);
      });
    }

    function showPage(page) {
      document.querySelectorAll(".page-section").forEach((sec) => sec.classList.remove("active"));
      let targetId = `page-${page}`;
      // 「媒介契約一覧」はダッシュボード下の表を再利用する
      if (page === "contracts") targetId = "page-dashboard";
      const target = el(targetId);
      if (target) {
        target.classList.add("active");
        const titleEl = target.querySelector(".page-title");
        if (titleEl && page === "contracts") titleEl.textContent = "媒介契約一覧";
      }
      if (page === "deadline") renderDeadlineTable();
      if (page === "register") renderRegisterTable();
      if (page === "closed" || page === "closed-contracted" || page === "closed-canceled" || page === "closed-purchased") renderClosedTable();
      if (page === "by-staff") {
        renderStaffSummary();
        renderByStaffTables();
      }
      if (page === "settings") renderGoalSettingsForm();
      if (page === "admin") renderAdminTable();
    }

    async function handleLogin(e) {
      e.preventDefault();
      const id = el("loginId").value.trim();
      const password = el("loginPassword").value;
      try {
        const res = await fetch("/api/login", {
          method: "POST",
          headers: { "Content-Type": "application/json; charset=utf-8" },
          credentials: "include",
          body: JSON.stringify({ id, password }),
        });
        if (!res.ok) {
          const err = await res.json();
          el("loginError").textContent = err.error || "ログインに失敗しました";
          el("loginError").classList.remove("hidden");
          return;
        }
        const data = await res.json();
        enterApp(data.user_id, data.login_id);
      } catch (err) {
        el("loginError").textContent = "ログインに失敗しました";
        el("loginError").classList.remove("hidden");
      }
    }

    function enterApp(userId, loginId) {
      el("loginView").classList.add("hidden");
      el("app").classList.remove("hidden");
      el("currentUser").textContent = userId || "-";
      el("userDropdownName").textContent = userId || "-";
      el("userDropdownId").textContent = loginId ? `@${loginId}` : "";
      state.currentUser = userId;
      state.loginId = loginId;
      loadAll();
      // ログイン時に通知をチェック
      setTimeout(() => checkNotifications(true), 500);
    }

    async function logout() {
      await fetch("/api/logout", { method: "POST", credentials: "include" });
      state.contracts = [];
      state.closed = [];
      state.summary = [];
      state.includeStaff = [];
      state.staffOrder = [];
      showLogin();
    }

    async function loadAll() {
      await Promise.all([loadMasters(), loadContracts(), loadSummary(), loadStatusColors(), loadGoals()]);
      renderFilters();
      renderStats();
      renderAlert();
      renderGoalSummary();
      renderGoalSettingsForm();
      renderTable();
      renderDeadlineTable();
      renderRegisterTable();
      renderClosedTable();
      renderByStaffTables();
      renderAdminTable();
    }

    async function apiFetch(url, options = {}) {
      const res = await fetch(url, {
        credentials: "include",
        headers: { "Content-Type": "application/json; charset=utf-8" },
        ...options,
      });
      if (!res.ok) {
        let msg = "エラーが発生しました";
        try { const body = await res.json(); msg = body.error || msg; } catch (_) {}
        throw new Error(msg);
      }
      return res.json();
    }

    function normalizeContract(raw) {
      return {
        raw,
        id: raw.id || "",
        staff: raw[K.staff] || "",
        type: raw[K.type] || "",
        status: raw[K.status] || "",
        statusDate: raw[K.statusDate] || "",
        signedDate: raw[K.signedDate] || "",
        expireDate: raw[K.expireDate] || "",
        propertyType: raw[K.propertyType] || "",
        address: raw[K.address] || "",
        owner: raw[K.owner] || "",
        ownerAddress: raw[K.ownerAddress] || "",
        ownerContact: raw[K.ownerContact] || "",
        price: raw[K.price],
        priceHistory: raw[K.priceHistory] || [],
        media: raw[K.media] || "",
        reinsFlag: raw[K.reinsFlag] ?? false,
        reinsExpire: raw[K.reinsExpire] || "",
        memo: raw[K.memo] || "",
        condition: raw[K.condition] || "",
        keyLocation: raw[K.keyLocation] || "",
        keyBoxNumber: raw[K.keyBoxNumber] || "",
        offerDate: raw[K.offerDate] || "",
        reinsChanged: raw[K.reinsChanged] ?? false,
        reinsChangeDate: raw[K.reinsChangeDate] || "",
        closeInfo: raw[K.closeInfo] || null,
        purchaseInfo: raw[K.purchaseInfo] || null,
        cancelInfo: raw[K.cancelInfo] || null,
        source_file: raw.source_file,
      };
    }

    function toPayload(norm, updates = {}) {
      const base = norm ? { ...norm.raw } : {};
      base.id = updates.id ?? norm?.id ?? base.id ?? "";
      base[K.staff] = updates.staff ?? norm?.staff ?? base[K.staff] ?? "";
      base[K.type] = updates.type ?? norm?.type ?? base[K.type] ?? "";
      base[K.status] = updates.status ?? norm?.status ?? base[K.status] ?? "";
      base[K.statusDate] = updates.statusDate ?? norm?.statusDate ?? base[K.statusDate] ?? "";
      base[K.signedDate] = updates.signedDate ?? norm?.signedDate ?? base[K.signedDate] ?? "";
      base[K.expireDate] = updates.expireDate ?? norm?.expireDate ?? base[K.expireDate] ?? "";
      base[K.propertyType] = updates.propertyType ?? norm?.propertyType ?? base[K.propertyType] ?? "";
      base[K.address] = updates.address ?? norm?.address ?? base[K.address] ?? "";
      base[K.owner] = updates.owner ?? norm?.owner ?? base[K.owner] ?? "";
      base[K.ownerAddress] = updates.ownerAddress ?? norm?.ownerAddress ?? base[K.ownerAddress] ?? "";
      base[K.ownerContact] = updates.ownerContact ?? norm?.ownerContact ?? base[K.ownerContact] ?? "";
      base[K.price] = updates.price ?? norm?.price ?? base[K.price];
      base[K.priceHistory] = updates.priceHistory ?? norm?.priceHistory ?? base[K.priceHistory] ?? [];
      base[K.media] = updates.media ?? norm?.media ?? base[K.media] ?? "";
      base[K.reinsFlag] = updates.reinsFlag ?? norm?.reinsFlag ?? base[K.reinsFlag] ?? false;
      base[K.reinsExpire] = updates.reinsExpire ?? norm?.reinsExpire ?? base[K.reinsExpire] ?? "";
      base[K.memo] = updates.memo ?? norm?.memo ?? base[K.memo] ?? "";
      base[K.condition] = updates.condition ?? norm?.condition ?? base[K.condition] ?? "";
      base[K.keyLocation] = updates.keyLocation ?? norm?.keyLocation ?? base[K.keyLocation] ?? "";
      base[K.keyBoxNumber] = updates.keyBoxNumber ?? norm?.keyBoxNumber ?? base[K.keyBoxNumber] ?? "";
      base[K.offerDate] = updates.offerDate ?? norm?.offerDate ?? base[K.offerDate] ?? "";
      base[K.reinsChanged] = updates.reinsChanged ?? norm?.reinsChanged ?? base[K.reinsChanged] ?? false;
      base[K.reinsChangeDate] = updates.reinsChangeDate ?? norm?.reinsChangeDate ?? base[K.reinsChangeDate] ?? "";
      base[K.closeInfo] = updates.closeInfo ?? norm?.closeInfo ?? base[K.closeInfo] ?? null;
      base[K.purchaseInfo] = updates.purchaseInfo ?? norm?.purchaseInfo ?? base[K.purchaseInfo] ?? null;
      base[K.cancelInfo] = updates.cancelInfo ?? norm?.cancelInfo ?? base[K.cancelInfo] ?? null;
      return base;
    }

    async function loadMasters() { try { state.masters = await apiFetch("/api/masters"); } catch (err) { console.error(err); } }
    async function loadStatusColors() { try { state.statusColors = await apiFetch("/api/status-colors"); } catch (err) { console.error(err); } }
    async function loadGoals() { try { state.goals = await apiFetch("/api/goals"); } catch (err) { console.error(err); } }

    async function loadContracts() {
      try {
        const [active, closed] = await Promise.all([apiFetch("/api/contracts/active"), apiFetch("/api/contracts/closed")]);
        state.contracts = active.map(normalizeContract);
        state.closed = closed.map(normalizeContract);
      } catch (err) { console.error(err); }
    }

    async function loadSummary() {
      try {
        const res = await apiFetch("/api/summary");
        state.summary = res.summary || [];
        state.includeStaff = res.includeStaff || [];
        state.staffOrder = res.staffOrder || [];
        renderChart();
        renderStaffSummary();
        renderGoalSummary();
      } catch (err) { console.error(err); }
    }

    function getAllStatusesForColors() {
      const set = new Set();
      (state.masters["取引状況"] || []).forEach((s) => set.add(s));
      Object.keys(STATUS_STYLES).forEach((s) => set.add(s));
      Object.keys(state.statusColors || {}).forEach((s) => set.add(s));
      return Array.from(set);
    }

    function renderStatusColorsForm() {
      const body = el("statusColorsBody"); if (!body) return;
      const statuses = getAllStatusesForColors().filter((s) => s);
      const isColor = (v) => typeof v === "string" && /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v);
      body.innerHTML = statuses.map((s) => {
        const style = (state.statusColors && state.statusColors[s]) || STATUS_STYLES[s] || {};
        const bg = isColor(style.bg) ? style.bg : "#e5e7eb";
        const color = isColor(style.color) ? style.color : "#111827";
        return `<tr data-status="${s}">
            <td>${s}</td>
            <td><input type="color" value="${bg}" data-field="bg" aria-label="${s}の背景色"></td>
            <td><input type="color" value="${color}" data-field="color" aria-label="${s}の文字色"></td>
          </tr>`;
      }).join("");
    }

    function openStatusColorsModal() {
      renderStatusColorsForm();
      openModal("modalStatusColors");
    }

    async function submitStatusColors(e) {
      e.preventDefault();
      const body = el("statusColorsBody");
      const colors = {};
      body.querySelectorAll("tr[data-status]").forEach((row) => {
        const status = row.dataset.status;
        const inputs = row.querySelectorAll("input[data-field]");
        const entry = {};
        inputs.forEach((input) => { entry[input.dataset.field] = input.value; });
        colors[status] = entry;
      });
      const res = await apiFetch("/api/status-colors", { method: "PUT", body: JSON.stringify(colors) });
      state.statusColors = res.colors || colors;
      closeModal("modalStatusColors");
      renderTable();
      renderDeadlineTable();
      renderClosedTable();
      renderAlert();
    }

    function renderFilters() {
      const staffSelect = el("filterStaff");
      staffSelect.innerHTML = `<option value="">担当を選択</option>`;
      (state.masters["担当"] || []).forEach((name) => staffSelect.insertAdjacentHTML("beforeend", `<option value="${name}">${name}</option>`));
      const statusSelect = el("filterStatus");
      statusSelect.innerHTML = `<option value="">ステータス</option>`;
      (state.masters["取引状況"] || []).forEach((s) => statusSelect.insertAdjacentHTML("beforeend", `<option value="${s}">${s}</option>`));
      fillOptions("formStaff", state.masters["担当"]);
      fillOptions("formPurchaseStaff", state.masters["担当"]);
      fillOptions("formType", state.masters["種別"]);
      fillOptions("formPropertyType", state.masters["物件"]);
      fillOptions("formMedia", state.masters["反響媒体"]);
      fillOptions("formCondition", state.masters["現況"]);
      fillOptions("formKeyLocation", state.masters["鍵の場所"]);
      fillOptions("formStatus", state.masters["取引状況"]);
    }

    function fillOptions(id, list = []) {
      const select = el(id); if (!select) return; select.innerHTML = "";
      list.forEach((item) => {
        const value = (id === "formKeyLocation" && item === KEYBOX_OLD_LABEL) ? KEYBOX_LABEL : item;
        select.insertAdjacentHTML("beforeend", `<option value="${value}">${value}</option>`);
      });
    }

    function formatDateDisplay(value) { return value ? value.replaceAll("-", "/") : "-"; }
    function formatPrice(value) { if (value === null || value === undefined || value === "") return "-"; const num = Number(value); if (Number.isNaN(num)) return value; return num.toLocaleString("ja-JP") + "万"; }
    function daysUntil(dateStr) { if (!dateStr) return null; return Math.floor((new Date(dateStr) - new Date()) / (1000 * 60 * 60 * 24)); }
    function getCurrentMonthKey(baseDate = new Date()) { return `${baseDate.getFullYear()}_${String(baseDate.getMonth() + 1).padStart(2, "0")}.json`; }
    function isSameMonth(dateStr, baseDate = new Date()) {
      if (!dateStr) return false;
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return false;
      return d.getFullYear() === baseDate.getFullYear() && d.getMonth() === baseDate.getMonth();
    }
    function getSoonExpiringContracts(limitDays = 14) {
      return state.contracts
        .map((c) => ({ ...c, remaining: daysUntil(c.expireDate) }))
        .filter((c) => c.remaining !== null && c.remaining <= limitDays && !["成約", "中止"].includes(c.status))
        .sort((a, b) => a.remaining - b.remaining);
    }

    function parseMonthKey(key) {
      const m = /^(\d{4})_(\d{2})\.json$/i.exec(key || "");
      if (!m) return null;
      return { year: Number(m[1]), month: Number(m[2]) };
    }

    function parseMonthFromDateStr(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return null;
      return { year: d.getFullYear(), month: d.getMonth() + 1 };
    }

    function getMonthlyInventoryBreakdown() {
      const map = new Map();
      const all = [...state.contracts, ...state.closed];

      const ensureEntry = (parsed) => {
        if (!parsed) return null;
        const key = `${parsed.year}-${String(parsed.month).padStart(2, "0")}`;
        if (!map.has(key)) map.set(key, { add: 0, contract: 0, purchase: 0, cancel: 0, parsed });
        return map.get(key);
      };

      // 追加（預かり）はsource_fileの月でカウント
      all.forEach((c) => {
        const entry = ensureEntry(parseMonthKey(c.raw?.source_file || c.source_file));
        if (entry) entry.add += 1;
      });

      // 成約・買取・中止は日付ベースで計上
      all.forEach((c) => {
        if (c.status === "成約") {
          const entry = ensureEntry(parseMonthFromDateStr(c.closeInfo?.成約日 || c.statusDate));
          if (entry) entry.contract += 1;
        }
        if (c.status === "買取") {
          const entry = ensureEntry(parseMonthFromDateStr(c.purchaseInfo?.買取日 || c.statusDate));
          if (entry) entry.purchase += 1;
        }
        if (c.status === "中止") {
          const entry = ensureEntry(parseMonthFromDateStr(c.cancelInfo?.中止日 || c.statusDate));
          if (entry) entry.cancel += 1;
        }
      });
      const sorted = Array.from(map.values()).sort((a, b) => {
        if (a.parsed.year !== b.parsed.year) return a.parsed.year - b.parsed.year;
        return a.parsed.month - b.parsed.month;
      });
      let inventory = 0;
      return sorted.map((entry) => {
        inventory = inventory + entry.add - entry.contract - entry.purchase - entry.cancel;
        return {
          label: `${entry.parsed.year}年${String(entry.parsed.month).padStart(2, "0")}月`,
          add: entry.add,
          contract: entry.contract,
          purchase: entry.purchase,
          cancel: entry.cancel,
          inventory,
        };
      });
    }

    function renderStats() {
      el("inventoryCount").textContent = state.contracts.length;
    }

    function renderAlert() {
      const soon = getSoonExpiringContracts(14);
      el("alertBanner").classList.toggle("hidden", soon.length === 0);
      el("alertText").textContent = `【重要】期間切れ間近の契約が${soon.length}件あります。ご確認ください。`;
    }

    function renderAlertDetailModal() {
      const body = el("alertModalBody"); if (!body) return;
      const soon = getSoonExpiringContracts(14);
      if (soon.length === 0) {
        body.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:16px;color:var(--gray-500);">14日以内に期限が近い案件はありません</td></tr>`;
        openModal("modalAlertDetail");
        return;
      }
      body.innerHTML = soon.map((c) => {
        const remainingText = c.remaining < 0 ? "期限切れ" : `あと${c.remaining}日`;
        return `<tr>
            <td>${c.id || "-"}</td>
            <td>${c.staff || "-"}</td>
            <td>${renderStatusBadge(c.status)}</td>
            <td>${formatDateDisplay(c.expireDate)}</td>
            <td>${remainingText}</td>
            <td class="address">${c.address || "-"}</td>
          </tr>`;
      }).join("");
      openModal("modalAlertDetail");
    }

    function renderChart() {
      const labels = state.summary.map((s) => s["担当"]);
      const dataset = (key, color) => ({ label: key, data: state.summary.map((s) => s[key] || 0), backgroundColor: color, stack: "stack" });
      const data = { labels, datasets: [dataset("専属", "#3b82f6"), dataset("専任", "#10b981"), dataset("一般", "#f59e0b")] };
      const ctx = document.getElementById("staffChart");
      if (state.chart) { state.chart.data = data; state.chart.update(); return; }
      state.chart = new Chart(ctx, { type: "bar", data, options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } } });
    }

    function renderStaffSummary() {
      const container = el("staffSummary"); if (!container) return;
      container.innerHTML = state.summary.map((s) => `<div class="staff-summary-row">${s["担当"]}の媒介件数${s.total}件 / 一般${s["一般"] || 0}件 専任${s["専任"] || 0}件 専属${s["専属"] || 0}件</div>`).join("");
    }

    function renderGoalSummary() {
      const overview = el("goalOverview");
      const list = el("goalStaffList");
      if (!overview || !list) return;
      const goals = state.goals || { storeTarget: 0, staffTargets: {}, includeStaff: [] };
      const storeTarget = Number(goals.storeTarget) || 0;
      const staffTargets = goals.staffTargets || {};
      const includeSet = new Set((goals.includeStaff || []).filter(Boolean));

      // 今月の追加はsource_file、今月の中止は中止日で差し引き
      const baseDate = new Date();
      const nowKey = getCurrentMonthKey(baseDate);
      const monthlyMap = new Map();
      const cancelMap = new Map();
      const allContracts = [...state.contracts, ...state.closed];
      allContracts.forEach((c) => {
        const sourceKey = c.raw?.source_file || c.source_file;
        if (sourceKey === nowKey) {
          const staff = c.staff || "未設定";
          monthlyMap.set(staff, (monthlyMap.get(staff) || 0) + 1);
        }
        if (c.status === "中止") {
          const cancelDate = c.cancelInfo?.中止日 || c.statusDate;
          if (!isSameMonth(cancelDate, baseDate)) return;
          const staff = c.staff || "未設定";
          cancelMap.set(staff, (cancelMap.get(staff) || 0) + 1);
        }
      });

      const names = new Set();
      (state.masters["担当"] || []).forEach((n) => names.add(n));
      state.summary.forEach((s) => names.add(s["担当"]));
      Object.keys(staffTargets).forEach((n) => names.add(n));
      monthlyMap.forEach((_, name) => names.add(name));
      cancelMap.forEach((_, name) => names.add(name));

      const filteredNames = includeSet.size > 0 ? Array.from(includeSet) : Array.from(names);
      // staffOrder に従って固定順でソート
      const orderMap = new Map((state.staffOrder || []).map((n, i) => [n, i]));
      filteredNames.sort((a, b) => {
        const ai = orderMap.has(a) ? orderMap.get(a) : 9999;
        const bi = orderMap.has(b) ? orderMap.get(b) : 9999;
        if (ai !== bi) return ai - bi;
        return a.localeCompare(b, "ja");
      });

      const rows = [];
      filteredNames.forEach((name) => {
        const added = monthlyMap.get(name) || 0;
        const canceled = cancelMap.get(name) || 0;
        rows.push({
          name,
          current: added - canceled,
          target: Number(staffTargets[name]) || 0
        });
      });

      const totalCurrent = rows.reduce((sum, r) => sum + r.current, 0);
      const storePercent = storeTarget ? Math.min(100, Math.max(0, Math.round((totalCurrent / storeTarget) * 100))) : 0;
      const storeRemain = storeTarget ? Math.max(0, storeTarget - totalCurrent) : null;
      overview.innerHTML = [
        `<span class="goal-pill">店舗: ${totalCurrent}件 / 目標${storeTarget || "-"}件 ${storeTarget ? `(${storePercent}%)` : "(目標未設定)"}</span>`,
        storeRemain !== null ? `<span class="goal-pill">残り ${storeRemain}件</span>` : `<span class="goal-pill" style="background:#fef2f2;color:#b91c1c;">目標を設定してください</span>`,
        `<span class="goal-pill">担当者 ${filteredNames.length}名</span>`
      ].join("");

      const renderItem = (name, current, target) => {
        const percent = target ? Math.min(100, Math.max(0, Math.round((current / target) * 100))) : 0;
        const remain = target ? Math.max(0, target - current) : null;
        const width = target ? Math.min(100, Math.max(0, (current / target) * 100)) : 0;
        const status = target ? `${current} / ${target}件 (${percent}%)` : `${current}件（目標未設定）`;
        const remainText = remain === null ? "目標を設定してください" : `残り ${remain}件`;
        return `<div class="goal-item">
            <div class="goal-item-header"><span>${name}</span><span>${status}</span></div>
            <div class="goal-progress"><div class="goal-progress-bar" style="width:${width}%;"></div></div>
            <div class="goal-progress-text">${remainText}</div>
          </div>`;
      };

      list.innerHTML = [
        renderItem("店舗合計", totalCurrent, storeTarget),
        ...rows.map((r) => renderItem(r.name, r.current, r.target))
      ].join("");
    }

    function renderGoalSettingsForm() {
      const body = el("goalSettingsBody"); if (!body) return;
      const goals = state.goals || { storeTarget: 0, staffTargets: {} };
      const staffTargets = goals.staffTargets || {};
      const includeSet = new Set((goals.includeStaff || []).filter(Boolean));
      const names = new Set();
      (state.masters["担当"] || []).forEach((n) => names.add(n));
      Object.keys(staffTargets).forEach((n) => names.add(n));
      state.summary.forEach((s) => names.add(s["担当"]));
      const rows = [];
      rows.push({ label: "店舗合計", key: "store", value: goals.storeTarget || 0, selectable: false });
      // staffOrder に従って固定順でソート
      const orderMap = new Map((state.staffOrder || []).map((n, i) => [n, i]));
      const sortedNames = Array.from(names).sort((a, b) => {
        const ai = orderMap.has(a) ? orderMap.get(a) : 9999;
        const bi = orderMap.has(b) ? orderMap.get(b) : 9999;
        if (ai !== bi) return ai - bi;
        return a.localeCompare(b, "ja");
      });
      sortedNames.forEach((name) => {
        rows.push({ label: name, key: name, value: Number(staffTargets[name]) || 0, selectable: true, checked: includeSet.size === 0 ? true : includeSet.has(name) });
      });
      body.innerHTML = rows.map((r) => `<tr>
          <td>${r.label}</td>
          <td><input type="number" min="0" class="goal-input" data-goal="${r.key}" value="${r.value}" aria-label="${r.label}の月間目標"></td>
          <td>${r.selectable ? `<label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" data-goal-include="${r.key}" ${r.checked ? "checked" : ""}> 目標に含める</label>` : "-"}</td>
        </tr>`).join("");
    }

    async function saveGoals() {
      const body = el("goalSettingsBody"); if (!body) return;
      const inputs = body.querySelectorAll("input[data-goal]");
      let storeTarget = 0;
      const staffTargets = {};
      const includeStaff = [];
      inputs.forEach((input) => {
        const key = input.dataset.goal;
        const val = Number(input.value || 0);
        if (key === "store") {
          storeTarget = Number.isNaN(val) ? 0 : val;
        } else {
          staffTargets[key] = Number.isNaN(val) ? 0 : val;
        }
      });
      const includes = body.querySelectorAll("input[data-goal-include]");
      includes.forEach((input) => {
        if (input.checked && input.dataset.goalInclude) includeStaff.push(input.dataset.goalInclude);
      });
      // includeStaffが空の場合は全員表示扱い
      try {
        const res = await apiFetch("/api/goals", { method: "PUT", body: JSON.stringify({ storeTarget, staffTargets, includeStaff }) });
        state.goals = res;
        renderGoalSummary();
        renderGoalSettingsForm();
        alert("目標を保存しました");
      } catch (err) {
        alert("保存に失敗しました");
        console.error(err);
      }
    }

    function renderMonthlyTrendModal() {
      const list = getMonthlyInventoryBreakdown();
      const body = el("monthlyTrendBody"); if (!body) return;
      if (!list.length) {
        body.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:16px;color:var(--gray-500);">データがありません</td></tr>`;
      } else {
        body.innerHTML = list.map((m) => `<tr>
            <td>${m.label}</td>
            <td>${m.add}件</td>
            <td>${m.contract}件</td>
            <td>${m.purchase}件</td>
            <td>${m.cancel}件</td>
            <td>${m.inventory}件</td>
          </tr>`).join("");
      }
      openModal("modalMonthlyTrend");
    }

    function renderDeadlineTable() {
      const body = el("deadlineBody"); if (!body) return;
      const soon = state.contracts.map((c) => ({ ...c, remaining: daysUntil(c.expireDate) }))
        .filter((c) => c.remaining !== null && c.remaining <= 20)
        .sort((a, b) => a.remaining - b.remaining);
      
      if (soon.length === 0) {
        body.innerHTML = `<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--gray-500);">20日以内に期限が来る案件はありません</td></tr>`;
        return;
      }
      
      body.innerHTML = soon.map((c) => {
        let rowClass = "";
        let badge = "";
        if (c.remaining < 0) {
          rowClass = "row-danger";
          badge = `<span class="badge" style="background:#dc2626;color:#fff;">期限切れ</span>`;
        } else if (c.remaining <= 7) {
          rowClass = "row-danger";
          badge = `<span class="badge" style="background:#f59e0b;color:#fff;">あと${c.remaining}日</span>`;
        } else if (c.remaining <= 14) {
          rowClass = "row-soft-warning";
          badge = `<span class="badge" style="background:#fcd34d;color:#92400e;">あと${c.remaining}日</span>`;
        } else {
          badge = `<span style="color:var(--gray-500);">${c.remaining}日</span>`;
        }
        return `<tr class="${rowClass}">
            <td>${c.id}</td>
            <td>${c.staff}</td>
            <td>${renderStatusBadge(c.status)}</td>
            <td>${formatDateDisplay(c.expireDate)}</td>
            <td>${badge}</td>
            <td class="address">${c.address || "-"}</td>
            <td>
              <button class="btn btn-outline" data-action="renew" data-id="${c.id}">更新</button>
              <button class="btn btn-outline" data-action="edit" data-id="${c.id}">編集</button>
            </td>
          </tr>`;
      }).join("");
      body.querySelectorAll("button[data-action]").forEach((btn) => btn.addEventListener("click", () => handleRowAction(btn.dataset.action, btn.dataset.id)));
    }

    function renderRegisterTable() {
      const body = el("registerBody"); if (!body) return;
      body.innerHTML = state.contracts.map((c) => `<tr>
            <td>${c.id}</td>
            <td>${c.staff}</td>
            <td>${c.type}</td>
            <td>${formatDateDisplay(c.signedDate)}</td>
            <td>${formatDateDisplay(c.expireDate)}</td>
            <td class="address">${c.address || "-"}</td>
            <td><button class="btn btn-outline" data-action="edit" data-id="${c.id}">編集</button></td>
          </tr>`).join("");
      body.querySelectorAll("button[data-action='edit']").forEach((btn) => btn.addEventListener("click", () => handleRowAction("edit", btn.dataset.id)));
    }

    function renderClosedTable() {
      const contractedBody = el("closedContractedBody");
      const purchasedBody = el("closedPurchasedBody");
      const canceledBody = el("closedCanceledBody");
      if (!contractedBody || !purchasedBody || !canceledBody) return;

      const queryContracted = (el("closedSearchContracted")?.value || "").toLowerCase();
      const queryPurchased = (el("closedSearchPurchased")?.value || "").toLowerCase();
      const queryCanceled = (el("closedSearchCanceled")?.value || "").toLowerCase();

      const filterList = (status, query) => {
        return state.closed
          .filter((c) => c.status === status)
          .filter((c) => {
            if (!query) return true;
            const haystack = [
              c.id, c.staff, c.type, c.address, c.propertyType, c.owner, c.memo
            ].map((v) => v || "").join(" ").toLowerCase();
            return haystack.includes(query);
          });
      };

      const renderRows = (list, kind) => {
        if (!list.length) {
          return `<tr><td colspan="6" style="text-align:center;padding:16px;color:var(--gray-500);">該当する案件はありません</td></tr>`;
        }
        return list.map((c) => {
          let infoText = "-";
          if (kind === "contracted") {
            const info = c.closeInfo || {};
            const d = formatDateDisplay(info.成約日);
            const p = info.成約価格 !== undefined && info.成約価格 !== "" ? formatPrice(info.成約価格) : "-";
            infoText = `成約日: ${d} / 価格: ${p}`;
          } else if (kind === "purchased") {
            const info = c.purchaseInfo || {};
            const d = formatDateDisplay(info.買取日);
            const p = info.買取価格 !== undefined && info.買取価格 !== "" ? formatPrice(info.買取価格) : "-";
            infoText = `買取日: ${d} / 価格: ${p}`;
          } else {
            const info = c.cancelInfo || {};
            const d = formatDateDisplay(info.中止日);
            infoText = `中止日: ${d} / 理由: ${info.中止理由 || "-"}`;
          }
          const actions = (kind === "purchased" && !c.id)
            ? "-"
            : `<div class="actions">
                  <button class="btn btn-outline" data-action="edit" data-id="${c.id}">編集</button>
                  <button class="btn btn-outline" data-action="reactivate" data-id="${c.id}">公開中に戻す</button>
                </div>`;
          return `<tr>
              <td>${c.id}</td>
              <td>${c.staff}</td>
              <td>${c.type}</td>
              <td class="address">${c.address || "-"}</td>
              <td>${infoText}</td>
              <td>${actions}</td>
            </tr>`;
        }).join("");
      };

      contractedBody.innerHTML = renderRows(filterList("成約", queryContracted), "contracted");
      purchasedBody.innerHTML = renderRows(filterList("買取", queryPurchased), "purchased");
      canceledBody.innerHTML = renderRows(filterList("中止", queryCanceled), "canceled");

      document.querySelectorAll("#closedContractedBody button[data-action], #closedPurchasedBody button[data-action], #closedCanceledBody button[data-action]").forEach((btn) => {
        btn.addEventListener("click", () => handleClosedAction(btn.dataset.action, btn.dataset.id));
      });
    }
    
    async function handleClosedAction(action, id) {
      if (!id) return;
      const contract = state.closed.find((c) => c.id === id);
      if (!contract) return;
      
      if (action === "edit") {
        const locked = await acquireLock(id);
        if (!locked) return;
        state.editingId = id;
        openContractModal(contract);
      } else if (action === "reactivate") {
        if (!confirm(`${id} を「公開中」に戻しますか？`)) return;
        const locked = await acquireLock(id);
        if (!locked) return;
        state.editingId = id;
        const updated = toPayload(contract, {
          status: "公開中",
          statusDate: new Date().toISOString().slice(0, 10),
          closeInfo: null,
          purchaseInfo: null,
          cancelInfo: null,
        });
        await apiFetch(`/api/contracts/${id}`, { method: "PUT", body: JSON.stringify(updated) });
        releaseLock();
        await loadContracts();
        await loadSummary();
        renderStats();
        renderTable();
        renderClosedTable();
        renderAlert();
      }
    }

    function renderByStaffTables() {
      const summaryBody = el("byStaffBody");
      if (summaryBody) {
        summaryBody.innerHTML = state.summary.map((s) => `<tr>
              <td>${s["担当"]}</td>
              <td>${s["専属"] || 0}</td>
              <td>${s["専任"] || 0}</td>
              <td>${s["一般"] || 0}</td>
              <td>${s.total || 0}</td>
            </tr>`).join("");
      }
      const listBody = el("byStaffContractsBody");
      if (listBody) {
        listBody.innerHTML = state.contracts.map((c) => `<tr>
              <td>${c.staff}</td>
              <td>${c.id}</td>
              <td>${c.type}</td>
              <td>${c.status}</td>
              <td>${formatDateDisplay(c.expireDate)}</td>
              <td class="address">${c.address || "-"}</td>
            </tr>`).join("");
      }
    }

    function renderAdminTable() {
      const body = el("adminBody"); if (!body) return;
      const all = [...state.contracts, ...state.closed];
      body.innerHTML = all.map((c) => `<tr>
            <td>${c.id}</td>
            <td>${c.status}</td>
            <td>${c.staff}</td>
            <td class="address">${c.address || "-"}</td>
            <td><button class="btn btn-danger" data-id="${c.id}">削除</button></td>
          </tr>`).join("");
      body.querySelectorAll("button.btn-danger").forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (confirm("このレコードを削除しますか？")) {
            await apiFetch(`/api/contracts/${btn.dataset.id}`, { method: "DELETE" });
            await loadContracts();
            renderTable();
            renderClosedTable();
            renderAdminTable();
            renderStats();
          }
        });
      });
    }

    function getFilteredContracts() {
      const { staff, status, from, to, query, closedOnly } = state.filters;
      const base = closedOnly ? state.closed : state.contracts;
      return base.filter((c) => {
        if (!closedOnly && c.status === "買取") return false;
        if (staff && c.staff !== staff) return false;
        if (status && c.status !== status) return false;
        if (from && c.signedDate && c.signedDate < from) return false;
        if (to && c.signedDate && c.signedDate > to) return false;
        if (query) {
          const q = query.toLowerCase();
          const haystack = [c.address || "", c.owner || "", c.ownerAddress || "", c.id || ""].join(" ").toLowerCase();
          if (!haystack.includes(q)) return false;
        }
        return true;
      }).sort((a, b) => {
        const key = state.sort.key;
        const dir = state.sort.dir === "asc" ? 1 : -1;
        
        // 媒介No.の場合は特別処理（年-月-連番でソート）
        if (key === "id") {
          return parseContractIdForSort(a.id, b.id) * dir;
        }
        
        const va = a[key] || "";
        const vb = b[key] || "";
        if (key === "price") return (Number(va) - Number(vb)) * dir;
        if (key.toLowerCase().includes("date")) return (new Date(va) - new Date(vb)) * dir;
        return String(va).localeCompare(String(vb), "ja") * dir;
      });
    }
    
    // 媒介No.を数値でソートするための比較関数
    function parseContractIdForSort(idA, idB) {
      const parseId = (id) => {
        const fallback = [9999, 99, 9999];
        if (!id) return fallback;
        const parts = id.split("-");
        if (parts.length !== 3) return fallback;

        let year;
        const yearPart = parts[0];
        if (/^r\d+$/i.test(yearPart)) {
          year = 2018 + (parseInt(yearPart.slice(1), 10) || 0);
        } else {
          const y = parseInt(yearPart, 10);
          if (Number.isNaN(y)) return fallback;
          year = y < 100 ? 2000 + y : y;
        }

        const month = parseInt(parts[1], 10);
        const seq = parseInt(parts[2], 10);
        if (Number.isNaN(month) || Number.isNaN(seq) || month < 1 || month > 12) return fallback;
        return [year, month, seq];
      };
      const [y1, m1, s1] = parseId(idA);
      const [y2, m2, s2] = parseId(idB);
      if (y1 !== y2) return y1 - y2;
      if (m1 !== m2) return m1 - m2;
      return s1 - s2;
    }

    function renderTable() {
      const body = el("contractsBody");
      body.innerHTML = "";
      getFilteredContracts().forEach((c) => {
        const statusBadge = renderStatusBadge(c.status);
        const typeBadge = `<span class="badge type-${c.type || ""}">${c.type || "-"}</span>`;
        const mediaDisplay = c.media ? toHalfKana(c.media) : "-";
        const propertyTypeDisplay = (() => {
          if (!c.propertyType) return "-";
          return c.propertyType.trim() === "マンション" ? toHalfKana(c.propertyType) : c.propertyType;
        })();
        const reinsExpireDisplay = c.reinsExpire ? formatDateDisplay(c.reinsExpire) : "-";
        const days = daysUntil(c.expireDate);
        let rowClass = "";
        if (c.status === "成約") rowClass = "row-closed";
        else if (c.status === "中止") rowClass = "row-cancel";
        else if (days !== null && days <= 7) rowClass = "row-danger";
        else if (days !== null && days <= 14) rowClass = "row-soft-warning";
        
        // 鍵の表示
        let keyDisplay = c.keyLocation || "-";
        if (isKeyBox(c.keyLocation)) {
          keyDisplay = KEYBOX_LABEL;
          if (c.keyBoxNumber) {
            keyDisplay = `${KEYBOX_LABEL}<br><span style="font-size:11px;color:#6b7280;">${c.keyBoxNumber}</span>`;
          }
        } else if (c.keyLocation === "当社") {
          keyDisplay = "🏢当社";
        }

        const changeCount = Math.max(0, (c.priceHistory ? c.priceHistory.length - 1 : 0));
        const priceHistoryButton = `<button class="btn btn-outline" style="padding:2px 8px;font-size:11px;" data-action="priceHistory" data-id="${c.id}">${changeCount} 履歴</button>`;

        body.insertAdjacentHTML("beforeend", `<tr class="${rowClass}">
            <td>${c.id || "-"}</td>
            <td>${statusBadge}</td>
            <td>${mediaDisplay}</td>
            <td>${c.staff || "-"}</td>
            <td>${typeBadge}</td>
            <td>${propertyTypeDisplay}</td>
            <td class="address" title="${c.address || ""}">${c.address || "-"}</td>
            <td>${c.owner || "-"}</td>
            <td>${c.ownerContact || "-"}</td>
            <td>${formatPrice(c.price)}</td>
            <td>${c.priceHistory && c.priceHistory.length ? priceHistoryButton : "-"}</td>
            <td>${formatDateDisplay(c.signedDate)}</td>
            <td>${formatDateDisplay(c.expireDate)}</td>
            <td>${reinsExpireDisplay}</td>
            <td>${keyDisplay}</td>
            <td>${c.condition || "-"}</td>
            <td><div class="actions">
              <button class="btn btn-outline" data-action="edit" data-id="${c.id}">編集</button>
            </div></td>
          </tr>`);
      });

      body.querySelectorAll("button[data-action]").forEach((btn) => {
        btn.addEventListener("click", () => handleRowAction(btn.dataset.action, btn.dataset.id));
      });
    }

    function toggleClosedView() { state.filters.closedOnly = !state.filters.closedOnly; el("btnShowClosed").textContent = state.filters.closedOnly ? "一覧に戻る" : "契約済み/買取/中止"; renderTable(); }

    function openModal(id) { const backdrop = el(id); if (backdrop) backdrop.classList.remove("hidden"); }
    function closeModal(id) { const backdrop = el(id); if (backdrop) backdrop.classList.add("hidden"); if (["modalContract","modalClose","modalPurchase","modalCancel","modalUpdate","modalChange"].includes(id)) releaseLock(); }

    function openContractModal(contract) {
      state.editingId = contract ? contract.id : null;
      const form = el("contractForm");
      form.reset();
      const editActionBox = el("editActionButtons");
      if (editActionBox) {
        editActionBox.classList.toggle("hidden", !contract);
      }
      
      // 条件付き表示をリセット
      el("keyBoxNumberGroup").style.display = "none";
      el("offerSection").style.display = "none";
      el("closeInfoSection").style.display = "none";
      el("cancelInfoSection").style.display = "none";
      el("formReinsChangeDate").disabled = true;
      
      if (contract) {
        el("modalContractTitle").textContent = "契約を編集";
        form.elements["id"].value = contract.id;
        form.elements["staff"].value = contract.staff || "";
        form.elements["type"].value = contract.type || "";
        form.elements["propertyType"].value = contract.propertyType || "";
        form.elements["address"].value = contract.address || "";
        form.elements["owner"].value = contract.owner || "";
        form.elements["ownerAddress"].value = contract.ownerAddress || "";
        form.elements["ownerContact"].value = contract.ownerContact || "";
        form.elements["signedDate"].value = contract.signedDate || "";
        form.elements["expireDate"].value = contract.expireDate || "";
        form.elements["price"].value = contract.price ?? "";
        form.elements["reinsFlag"].value = String(Boolean(contract.reinsFlag));
        form.elements["reinsExpire"].value = contract.reinsExpire || "";
        form.elements["media"].value = contract.media || "";
        form.elements["condition"].value = contract.condition || "";
        form.elements["keyLocation"].value = normalizeKeyLocation(contract.keyLocation) || "";
        form.elements["status"].value = contract.status || "";
        form.elements["memo"].value = contract.memo || "";
        
        // ｷｰﾎﾞｯｸｽ番号
        if (isKeyBox(contract.keyLocation)) {
          el("keyBoxNumberGroup").style.display = "block";
          form.elements["keyBoxNumber"].value = contract.keyBoxNumber || "";
        }
        
        // 申込情報
        if (contract.status === "書面による購入申込みあり") {
          el("offerSection").style.display = "block";
          form.elements["offerDate"].value = contract.offerDate || "";
          form.elements["reinsChanged"].value = String(Boolean(contract.reinsChanged));
          form.elements["reinsChangeDate"].value = contract.reinsChangeDate || "";
          if (contract.reinsChanged) {
            el("formReinsChangeDate").disabled = false;
          }
        }
        
        // 成約情報
        if (contract.status === "成約") {
          el("closeInfoSection").style.display = "block";
          const info = contract.closeInfo || {};
          form.elements["closeDate"].value = info.成約日 || "";
          form.elements["closePrice"].value = info.成約価格 || "";
          form.elements["dealType"].value = info.取引形態 || "";
          form.elements["closeRegDate"].value = info.成約登録日 || "";
        }
        
        // 中止情報
        if (contract.status === "中止") {
          el("cancelInfoSection").style.display = "block";
          const info = contract.cancelInfo || {};
          form.elements["cancelDate"].value = info.中止日 || "";
          form.elements["reinsDeleted"].value = String(Boolean(info.レインズ削除済み));
          form.elements["cancelReason"].value = info.中止理由 || "";
        }
      } else { 
        el("modalContractTitle").textContent = "新規媒介登録"; 
      }
      openModal("modalContract");
    }

    async function handleRowAction(action, id) {
      const contract = [...state.contracts, ...state.closed].find((c) => c.id === id);
      if (!contract) return;
      if (action === "priceHistory") {
        openPriceHistoryModal(contract);
        return;
      }
      if (["edit", "close", "purchase", "cancel", "renew", "change"].includes(action)) {
        const locked = await acquireLock(id);
        if (!locked) return;
        state.editingId = id;
      }
      if (action === "edit") openContractModal(contract);
      else if (action === "renew") openUpdateModal(contract);
      else if (action === "change") openChangeModal(contract);
      else if (action === "close") openCloseModal(contract);
      else if (action === "purchase") openPurchaseModal(contract);
      else if (action === "cancel") openCancelModal(contract);
      else if (action === "delete") {
        if (confirm("削除してよろしいですか？")) {
          await apiFetch(`/api/contracts/${id}`, { method: "DELETE" });
          await loadContracts();
          renderTable();
          renderStats();
          renderAlert();
        }
      }
    }

    function openCloseModal(contract) {
      const form = el("closeForm");
      form.reset();
      form.elements["id"].value = contract.id;
      form.elements["address"].value = contract.address || "";
      openModal("modalClose");
    }

    function openUpdateModal(contract) {
      const form = el("updateForm");
      form.reset();
      form.elements["id"].value = contract.id;
      form.elements["address"].value = contract.address || "";
      form.elements["currentExpire"].value = contract.expireDate || "";
      openModal("modalUpdate");
    }

    function openChangeModal(contract) {
      const form = el("changeForm");
      form.reset();
      form.elements["id"].value = contract.id;
      form.elements["address"].value = contract.address || "";
      form.elements["currentPrice"].value = formatPrice(contract.price);
      form.elements["newPrice"].value = contract.price ?? "";
      form.elements["changeDate"].value = new Date().toISOString().slice(0, 10);
      el("changeReinsToggle").checked = false;
      el("changeReinsDate").value = "";
      el("changeReinsDate").disabled = true;
      openModal("modalChange");
    }

    function openPurchaseModal(contract) {
      const form = el("purchaseForm");
      form.reset();
      form.elements["id"].value = contract.id;
      form.elements["address"].value = contract.address || "";
      form.elements["purchaseDate"].value = new Date().toISOString().slice(0, 10);
      form.elements["purchasePrice"].value = contract.price ?? "";
      openModal("modalPurchase");
    }

    function openNewPurchaseModal() {
      const form = el("newPurchaseForm");
      if (!form) return;
      form.reset();
      form.elements["purchaseDate"].value = new Date().toISOString().slice(0, 10);
      openModal("modalNewPurchase");
    }

    function openCancelModal(contract) {
      const form = el("cancelForm");
      form.reset();
      form.elements["id"].value = contract.id;
      form.elements["address"].value = contract.address || "";
      openModal("modalCancel");
    }

    async function submitContract(e) {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      data.reinsFlag = data.reinsFlag === "true";
      data.reinsChanged = data.reinsChanged === "true";
      if (data.price !== "") data.price = Number(data.price);
      
      // 申込あり以外の場合は申込関連フィールドをクリア
      if (data.status !== "書面による購入申込みあり") {
        data.offerDate = "";
        data.reinsChanged = false;
        data.reinsChangeDate = "";
      }
      
      data.keyLocation = normalizeKeyLocation(data.keyLocation);

      // ｷｰﾎﾞｯｸｽ以外の場合は番号をクリア
      if (!isKeyBox(data.keyLocation)) {
        data.keyBoxNumber = "";
      }
      
      // 成約情報
      if (data.status === "成約") {
        data.closeInfo = {
          成約日: data.closeDate || "",
          成約価格: data.closePrice ? Number(data.closePrice) : "",
          取引形態: data.dealType || "",
          成約登録日: data.closeRegDate || ""
        };
        data.cancelInfo = null;
      } else {
        data.closeInfo = null;
      }
      
      // 中止情報
      if (data.status === "中止") {
        data.cancelInfo = {
          中止日: data.cancelDate || "",
          レインズ削除済み: data.reinsDeleted === "true",
          中止理由: data.cancelReason || ""
        };
        data.closeInfo = null;
      } else if (data.status !== "成約") {
        data.cancelInfo = null;
      }
      
      // フォームの一時フィールドを削除
      delete data.closeDate;
      delete data.closePrice;
      delete data.dealType;
      delete data.closeRegDate;
      delete data.cancelDate;
      delete data.reinsDeleted;
      delete data.cancelReason;
      
      const norm = [...state.contracts, ...state.closed].find((c) => c.id === data.id);
      if (data.status === "買取") {
        data.purchaseInfo = norm?.purchaseInfo || null;
      } else {
        data.purchaseInfo = null;
      }
      if (norm) {
        const base = { ...data, priceHistory: norm.priceHistory };
        if (data.price && norm.price !== data.price) {
          const history = norm.priceHistory ? [...norm.priceHistory] : [];
          history.push({ 日付: new Date().toISOString().slice(0, 10), 価格: data.price });
          base.priceHistory = history;
        }
        // ステータスが変わった場合はstatusDateを更新
        const statusDate = (norm.status !== data.status) 
          ? new Date().toISOString().slice(0, 10) 
          : (norm.statusDate || data.signedDate || new Date().toISOString().slice(0, 10));
        const payload = toPayload(norm, { ...base, statusDate });
        await apiFetch(`/api/contracts/${norm.id}`, { method: "PUT", body: JSON.stringify(payload) });
      } else {
        const firstPriceDate = data.signedDate || new Date().toISOString().slice(0, 10);
        const payload = toPayload(null, {
          ...data,
          priceHistory: data.price ? [{ 日付: firstPriceDate, 価格: data.price }] : [],
          statusDate: data.signedDate || new Date().toISOString().slice(0, 10),
        });
        await apiFetch("/api/contracts", { method: "POST", body: JSON.stringify(payload) });
      }
      closeModal("modalContract");
      await loadContracts();
      await loadSummary();
      renderStats();
      renderTable();
      renderClosedTable();
      renderAlert();
    }

    async function submitUpdate(e) {
      e.preventDefault();
      const form = e.target;
      const id = form.elements["id"].value;
      const contract = [...state.contracts, ...state.closed].find((c) => c.id === id);
      if (!contract) return;
      const updated = toPayload(contract, {
        expireDate: form.elements["newExpire"].value || contract.expireDate,
        reinsExpire: form.elements["newReinsExpire"].value || contract.reinsExpire,
        statusDate: form.elements["newExpire"].value || contract.statusDate || new Date().toISOString().slice(0, 10),
      });
      await apiFetch(`/api/contracts/${id}`, { method: "PUT", body: JSON.stringify(updated) });
      closeModal("modalUpdate");
      await loadContracts();
      await loadSummary();
      renderStats();
      renderTable();
      renderClosedTable();
      renderAlert();
    }

    async function submitChange(e) {
      e.preventDefault();
      const form = e.target;
      const id = form.elements["id"].value;
      const contract = [...state.contracts, ...state.closed].find((c) => c.id === id);
      if (!contract) return;
      const newPrice = Number(form.elements["newPrice"].value);
      if (Number.isNaN(newPrice)) { alert("価格を入力してください"); return; }
      const changeDate = form.elements["changeDate"].value;
      if (!changeDate) { alert("変更日を入力してください"); return; }
      const history = contract.priceHistory ? [...contract.priceHistory] : [];
      history.push({ 日付: changeDate, 価格: newPrice });
      const updated = toPayload(contract, {
        price: newPrice,
        priceHistory: history,
        reinsExpire: el("changeReinsToggle").checked ? form.elements["newReinsExpire"].value || contract.reinsExpire : contract.reinsExpire,
        statusDate: changeDate,
      });
      await apiFetch(`/api/contracts/${id}`, { method: "PUT", body: JSON.stringify(updated) });
      closeModal("modalChange");
      await loadContracts();
      await loadSummary();
      renderStats();
      renderTable();
      renderClosedTable();
      renderAlert();
    }

    async function submitPurchase(e) {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const id = data.id;
      const contract = [...state.contracts, ...state.closed].find((c) => c.id === id);
      if (!contract) return;
      const purchasePrice = Number(data.purchasePrice);
      if (Number.isNaN(purchasePrice)) { alert("買取価格を入力してください"); return; }
      if (!data.purchaseDate) { alert("買取日を入力してください"); return; }
      const updated = toPayload(contract, {
        status: "買取",
        statusDate: data.purchaseDate,
        purchaseInfo: { 買取日: data.purchaseDate, 買取価格: purchasePrice },
        closeInfo: null,
        cancelInfo: null,
      });
      await apiFetch(`/api/contracts/${id}`, { method: "PUT", body: JSON.stringify(updated) });
      closeModal("modalPurchase");
      await loadContracts();
      await loadSummary();
      renderStats();
      renderTable();
      renderClosedTable();
      renderAlert();
    }

    async function submitNewPurchase(e) {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      if (!data.purchaseDate) { alert("買取日を入力してください"); return; }
      if (!data.staff) { alert("担当を選択してください"); return; }
      const price = Number(data.price);
      if (Number.isNaN(price)) { alert("買取価格を入力してください"); return; }
      const payload = {
        purchaseDate: data.purchaseDate,
        staff: data.staff,
        address: data.address || "",
        price,
        memo: data.memo || "",
      };
      await apiFetch("/api/purchases", { method: "POST", body: JSON.stringify(payload) });
      closeModal("modalNewPurchase");
      await loadContracts();
      await loadSummary();
      renderStats();
      renderTable();
      renderClosedTable();
      renderAlert();
      renderGoalSummary();
    }

    async function submitClose(e) {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const id = data.id;
      const contract = [...state.contracts, ...state.closed].find((c) => c.id === id);
      if (!contract) return;
      const updated = toPayload(contract, {
        status: "成約",
        statusDate: data.closeDate,
        closeInfo: { 成約日: data.closeDate, 成約価格: Number(data.closePrice), 取引形態: data.dealType, 成約登録日: data.closeRegDate },
      });
      await apiFetch(`/api/contracts/${id}`, { method: "PUT", body: JSON.stringify(updated) });
      closeModal("modalClose");
      await loadContracts();
      await loadSummary();
      renderStats();
      renderTable();
      renderClosedTable();
      renderAlert();
    }

    async function submitCancel(e) {
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());
      const id = data.id;
      const contract = [...state.contracts, ...state.closed].find((c) => c.id === id);
      if (!contract) return;
      const updated = toPayload(contract, {
        status: "中止",
        statusDate: data.cancelDate,
        cancelInfo: { 中止日: data.cancelDate, レインズ削除済み: data.reinsDeleted === "true", 中止理由: data.cancelReason },
      });
      await apiFetch(`/api/contracts/${id}`, { method: "PUT", body: JSON.stringify(updated) });
      closeModal("modalCancel");
      await loadContracts();
      await loadSummary();
      renderStats();
      renderTable();
      renderClosedTable();
      renderAlert();
    }

    async function acquireLock(id) {
      try {
        const res = await fetch(`/api/contracts/${id}/lock`, {
          method: "POST",
          headers: { "Content-Type": "application/json; charset=utf-8" },
          credentials: "include",
          body: JSON.stringify({ user: el("currentUser").textContent || "user" }),
        });
        if (res.status === 423) {
          const body = await res.json();
          alert(`このレコードは現在 ${body.by} さんが編集中です（${body.expires_at}まで）`);
          return false;
        }
        return true;
      } catch (err) { alert("ロック取得に失敗しました"); return false; }
    }

    async function releaseLock() {
      if (!state.editingId) return;
      try { await fetch(`/api/contracts/${state.editingId}/unlock`, { method: "POST", credentials: "include" }); } catch (_) {}
      state.editingId = null;
    }

    function openMastersModal() {
      const form = el("mastersForm");
      Object.entries(state.masters || {}).forEach(([key, list]) => { if (form.elements[key]) form.elements[key].value = list.join(", "); });
      openModal("modalMasters");
    }

    async function submitMasters(e) {
      e.preventDefault();
      const form = e.target;
      const payload = {};
      Array.from(form.elements).filter((el) => el.name).forEach((el) => { payload[el.name] = el.value.split(",").map((x) => x.trim()).filter(Boolean); });
      await apiFetch("/api/masters", { method: "PUT", body: JSON.stringify(payload) });
      closeModal("modalMasters");
      await loadMasters();
      renderFilters();
    }

    // 価格推移モーダル
    function openPriceHistoryModal(contract) {
      el("priceHistoryId").textContent = contract.id;
      const body = el("priceHistoryBody");
      const history = contract.priceHistory || [];
      if (history.length === 0) {
        body.innerHTML = `<tr><td colspan="2" style="text-align:center;padding:16px;color:var(--gray-500);">価格推移がありません</td></tr>`;
      } else {
        body.innerHTML = history.map((h, idx) => `<tr style="background:${idx === history.length - 1 ? '#f0fdf4' : 'transparent'}">
          <td style="padding:8px;border-bottom:1px solid var(--gray-200);">${formatDateDisplay(h.日付 || h.date || "")}</td>
          <td style="padding:8px;border-bottom:1px solid var(--gray-200);text-align:right;font-weight:${idx === history.length - 1 ? '700' : '400'};">${formatPrice(h.価格 || h.price)}</td>
        </tr>`).join("");
      }
      openModal("modalPriceHistory");
    }

    // バックアップ管理
    async function openBackupModal() {
      openModal("modalBackup");
      await loadBackupList();
    }

    // ロック管理
    async function openLockModal() {
      openModal("modalLocks");
      await loadLockList();
    }

    async function loadLockList() {
      try {
        const list = await apiFetch("/api/locks");
        const body = el("lockListBody");
        if (!list || list.length === 0) {
          body.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:16px;color:var(--gray-500);">ロックはありません</td></tr>`;
          return;
        }
        body.innerHTML = list.map((l) => `<tr>
          <td>${l.contract_id}</td>
          <td>${l.user || "-"}</td>
          <td>${formatDateTimeDisplay(l.locked_at)}</td>
          <td>${formatDateTimeDisplay(l.expires_at)}</td>
          <td><button class="btn btn-outline" data-lock-release="${l.contract_id}">解除</button></td>
        </tr>`).join("");
        body.querySelectorAll("button[data-lock-release]").forEach((btn) => {
          btn.addEventListener("click", () => releaseLockManual(btn.dataset.lockRelease));
        });
      } catch (err) {
        el("lockListBody").innerHTML = `<tr><td colspan="5" style="color:var(--danger-color);padding:16px;">読み込みエラー: ${err.message}</td></tr>`;
      }
    }

    async function releaseLockManual(contractId) {
      if (!confirm(`${contractId} のロックを解除しますか？`)) return;
      try {
        await apiFetch(`/api/locks/${contractId}`, { method: "DELETE" });
        await loadLockList();
      } catch (err) {
        alert("解除に失敗しました: " + err.message);
      }
    }

    async function loadBackupList() {
      try {
        const list = await apiFetch("/api/backup/list");
        const body = el("backupListBody");
        if (list.length === 0) {
          body.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:16px;color:var(--gray-500);">バックアップがありません</td></tr>`;
        } else {
          body.innerHTML = list.map((b) => `<tr>
            <td>${formatDateTimeDisplay(b.updated_at)}</td>
            <td style="font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;">${b.destination}</td>
            <td>${b.folder}</td>
          </tr>`).join("");
        }
      } catch (err) {
        el("backupListBody").innerHTML = `<tr><td colspan="3" style="color:var(--danger-color);">読み込みエラー: ${err.message}</td></tr>`;
      }
    }

    async function runBackup() {
      const btn = el("btnRunBackup");
      btn.disabled = true;
      btn.textContent = "実行中...";
      try {
        await apiFetch("/api/backup/run", { method: "POST" });
        alert("バックアップが完了しました");
        await loadBackupList();
      } catch (err) {
        alert("バックアップに失敗しました: " + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "今すぐバックアップ";
      }
    }

    function formatDateTimeDisplay(iso) {
      if (!iso) return "-";
      const d = new Date(iso);
      return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    // CSVエクスポート機能
    let currentExportMode = "dashboard";
    
    function openExportModal(mode) {
      currentExportMode = mode;
      openModal("modalExport");
    }
    
    function executeExport(exportAll) {
      let data = [];
      let filename = "";
      const today = new Date().toISOString().slice(0, 10).replace(/-/g, "");
      
      switch (currentExportMode) {
        case "dashboard":
          data = exportAll ? state.contracts : getFilteredContracts();
          filename = `媒介契約一覧_${today}.csv`;
          downloadCSV(data, filename, "contracts");
          break;
        case "deadline":
          const deadlineData = state.contracts.map((c) => ({ ...c, remaining: daysUntil(c.expireDate) }))
            .filter((c) => c.remaining !== null && c.remaining <= 20)
            .sort((a, b) => a.remaining - b.remaining);
          data = exportAll ? state.contracts.filter((c) => c.expireDate) : deadlineData;
          filename = `期限管理_${today}.csv`;
          downloadCSV(data, filename, "deadline");
          break;
        case "closed":
          data = exportAll ? [...state.contracts, ...state.closed] : state.closed;
          filename = `契約済み中止リスト_${today}.csv`;
          downloadCSV(data, filename, "closed");
          break;
        case "byStaff":
          data = exportAll ? state.contracts : state.contracts;
          filename = `担当別管理_${today}.csv`;
          downloadCSV(data, filename, "byStaff");
          break;
      }
      
      closeModal("modalExport");
    }
    
    function downloadCSV(data, filename, type) {
      let headers = [];
      let rows = [];
      
      switch (type) {
        case "contracts":
          headers = ["媒介No.", "取引状況", "反響媒体", "担当", "種別", "物件種別", "物件所在地（市町村から）", "売主", "売主連絡先", "媒介価格", "初回媒介日", "媒介期日", "レインズ登録", "レインズ満了日", "鍵の場所", "ｷｰﾎﾞｯｸｽ番号", "ステータス日付", "現況", "備考"];
          rows = data.map((c) => [
            c.id, c.status, c.media, c.staff, c.type, c.propertyType, c.address, c.owner, c.ownerContact, c.price || "",
            c.signedDate, c.expireDate, c.reinsFlag ? "登録済" : "未登録", c.reinsExpire,
            c.keyLocation, c.keyBoxNumber || "", c.statusDate, c.condition, c.memo
          ]);
          break;
        case "deadline":
          headers = ["媒介No.", "担当", "取引状況", "媒介期日", "残日数", "物件所在地（市町村から）"];
          rows = data.map((c) => [
            c.id, c.staff, c.status, c.expireDate, c.remaining !== undefined ? c.remaining : daysUntil(c.expireDate), c.address
          ]);
          break;
        case "closed":
          headers = ["媒介No.", "取引状況", "ステータス日付", "担当", "種別", "物件所在地（市町村から）", "成約/買取/中止日", "成約/買取価格 または 中止理由"];
          rows = data.map((c) => {
            let infoDate = "";
            let infoDetail = "";
            if (c.status === "成約") {
              infoDate = c.closeInfo?.成約日 || "";
              infoDetail = c.closeInfo?.成約価格 || "";
            } else if (c.status === "買取") {
              infoDate = c.purchaseInfo?.買取日 || "";
              infoDetail = c.purchaseInfo?.買取価格 || "";
            } else {
              infoDate = c.cancelInfo?.中止日 || "";
              infoDetail = c.cancelInfo?.中止理由 || "";
            }
            return [c.id, c.status, c.statusDate, c.staff, c.type, c.address, infoDate, infoDetail];
          });
          break;
        case "byStaff":
          headers = ["担当", "媒介No.", "種別", "取引状況", "媒介期日", "物件所在地（市町村から）"];
          rows = data.map((c) => [c.staff, c.id, c.type, c.status, c.expireDate, c.address]);
          rows.sort((a, b) => a[0].localeCompare(b[0], "ja"));
          break;
      }
      
      // BOM付きUTF-8でCSV生成
      const csvContent = [headers, ...rows].map((row) => 
        row.map((cell) => `"${String(cell || "").replace(/"/g, '""')}"`).join(",")
      ).join("\r\n");
      
      const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
      const blob = new Blob([bom, csvContent], { type: "text/csv;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // ================== 通知機能 ==================
    
    // 既読通知をlocalStorageで管理
    function getReadNotifications() {
      try {
        return JSON.parse(localStorage.getItem("readNotifications") || "{}");
      } catch { return {}; }
    }
    
    function setReadNotification(id) {
      const read = getReadNotifications();
      read[id] = new Date().toISOString();
      localStorage.setItem("readNotifications", JSON.stringify(read));
    }
    
    function isNotificationRead(notification) {
      const read = getReadNotifications();
      // 期限通知は毎日表示（日付でIDが変わる）
      // ステータス・価格変更は1回だけ
      return !!read[notification.id];
    }
    
    // 古い既読情報をクリーンアップ（7日以上前）
    function cleanupOldReadNotifications() {
      const read = getReadNotifications();
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - 7);
      const cleaned = {};
      for (const [id, dateStr] of Object.entries(read)) {
        if (new Date(dateStr) > cutoff) {
          cleaned[id] = dateStr;
        }
      }
      localStorage.setItem("readNotifications", JSON.stringify(cleaned));
    }
    
    async function checkNotifications(showModal = false) {
      try {
        cleanupOldReadNotifications();
        const notifications = await apiFetch("/api/notifications");
        state.notifications = notifications;
        
        // 未読のみフィルター
        const unread = notifications.filter((n) => !isNotificationRead(n));
        
        // バッジ更新
        const badge = el("notificationBadge");
        if (unread.length > 0) {
          badge.textContent = unread.length > 99 ? "99+" : unread.length;
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }
        
        // ドロップダウン更新
        renderNotificationDropdown(unread);
        
        // ログイン時にモーダル表示
        if (showModal && unread.length > 0) {
          renderNotificationModal(unread);
          openModal("modalNotifications");
          // ブラウザ通知も送る
          sendBrowserNotifications(unread);
        }
      } catch (err) {
        console.error("通知の取得に失敗:", err);
      }
    }
    
    function renderNotificationDropdown(notifications) {
      const list = el("notificationList");
      if (notifications.length === 0) {
        list.innerHTML = `<div class="notification-empty">新しい通知はありません</div>`;
        return;
      }
      
      list.innerHTML = notifications.slice(0, 20).map((n) => {
        let icon = "🔔";
        if (n.type === "status_change") icon = "🔄";
        else if (n.type === "price_change") icon = "💴";
        else if (n.type === "deadline_expired") icon = "⏰";
        
        return `<div class="notification-item unread" data-id="${n.id}">
          <span class="notification-item-icon">${icon}</span>
          <div>
            <div class="notification-item-text">${n.message}</div>
            <div class="notification-item-date">${n.address || ""}</div>
          </div>
        </div>`;
      }).join("");
      
      // クリックで既読にする
      list.querySelectorAll(".notification-item").forEach((item) => {
        item.addEventListener("click", () => {
          const id = item.dataset.id;
          setReadNotification(id);
          item.classList.remove("unread");
          checkNotifications(false);
        });
      });
    }
    
    function renderNotificationModal(notifications) {
      const content = el("notificationModalContent");
      
      // 種類別に分類
      const deadlines = notifications.filter((n) => n.type === "deadline" || n.type === "deadline_expired");
      const statusChanges = notifications.filter((n) => n.type === "status_change");
      const priceChanges = notifications.filter((n) => n.type === "price_change");
      
      let html = "";
      
      if (deadlines.length > 0) {
        html += `<div class="notification-section">
          <h4 class="notification-section-title">⏰ 期限が近い契約 (${deadlines.length}件)</h4>
          ${deadlines.map((n) => {
            const cls = n.days_left <= 7 ? "deadline" : "deadline-warning";
            return `<div class="notification-modal-item ${cls}">
              <strong>${n.contract_id}</strong> - ${n.message}<br>
              <small>${n.address || ""}</small>
            </div>`;
          }).join("")}
        </div>`;
      }
      
      if (statusChanges.length > 0) {
        html += `<div class="notification-section">
          <h4 class="notification-section-title">🔄 ステータス変更 (${statusChanges.length}件)</h4>
          ${statusChanges.map((n) => `<div class="notification-modal-item status">
            <strong>${n.contract_id}</strong> - ${n.message}<br>
            <small>${n.address || ""} (${n.date})</small>
          </div>`).join("")}
        </div>`;
      }
      
      if (priceChanges.length > 0) {
        html += `<div class="notification-section">
          <h4 class="notification-section-title">💴 価格変更 (${priceChanges.length}件)</h4>
          ${priceChanges.map((n) => `<div class="notification-modal-item price">
            <strong>${n.contract_id}</strong> - ${n.message}<br>
            <small>${n.address || ""} (${n.date})</small>
          </div>`).join("")}
        </div>`;
      }
      
      if (html === "") {
        html = `<p style="text-align:center;color:var(--gray-500);">新しい通知はありません</p>`;
      }
      
      content.innerHTML = html;
      
      // モーダルを閉じたら既読にする
      const modal = el("modalNotifications");
      modal.querySelector("[data-close='modalNotifications']").addEventListener("click", () => {
        notifications.forEach((n) => setReadNotification(n.id));
        checkNotifications(false);
      }, { once: true });
    }
    
    function toggleNotificationDropdown() {
      const dropdown = el("notificationDropdown");
      dropdown.classList.toggle("hidden");
    }
    
    function clearAllNotifications() {
      state.notifications.forEach((n) => setReadNotification(n.id));
      checkNotifications(false);
      el("notificationDropdown").classList.add("hidden");
    }
    
    // ブラウザ通知
    function requestBrowserNotificationPermission() {
      if (!("Notification" in window)) {
        alert("このブラウザはデスクトップ通知に対応していません");
        return;
      }
      
      Notification.requestPermission().then((permission) => {
        if (permission === "granted") {
          alert("ブラウザ通知が許可されました");
          new Notification("媒介契約管理システム", {
            body: "通知が有効になりました",
            icon: "🔔"
          });
        } else {
          alert("通知が拒否されました。ブラウザの設定から許可してください。");
        }
      });
    }
    
    function sendBrowserNotifications(notifications) {
      if (!("Notification" in window) || Notification.permission !== "granted") {
        return;
      }
      
      // 通知をまとめて1つだけ送る
      const deadlineCount = notifications.filter((n) => n.type === "deadline" || n.type === "deadline_expired").length;
      const changeCount = notifications.filter((n) => n.type === "status_change" || n.type === "price_change").length;
      
      let body = "";
      if (deadlineCount > 0) body += `期限通知: ${deadlineCount}件
`;
      if (changeCount > 0) body += `変更通知: ${changeCount}件`;
      
      if (body) {
        new Notification("媒介契約管理システム", {
          body: body.trim(),
          tag: "baikaiyaku-notification",
          requireInteraction: true
        });
      }
    }

    // ================== ユーザー機能 ==================
    
    function toggleUserDropdown() {
      el("userDropdown").classList.toggle("hidden");
    }
    
    async function openUserListModal() {
      openModal("modalUserList");
      try {
        const users = await apiFetch("/api/users");
        const body = el("userListBody");
        body.innerHTML = users.map((u) => `<tr>
          <td style="padding:8px;border-bottom:1px solid var(--gray-200);">${u.login_id}</td>
          <td style="padding:8px;border-bottom:1px solid var(--gray-200);">${u.display_name}</td>
          <td style="padding:8px;border-bottom:1px solid var(--gray-200);text-align:center;">
            ${u.is_admin ? '<span class="badge" style="background:#7c3aed;color:#fff;">管理者</span>' : '<span class="badge" style="background:var(--gray-200);color:var(--gray-700);">一般</span>'}
          </td>
        </tr>`).join("");
      } catch (err) {
        el("userListBody").innerHTML = `<tr><td colspan="3" style="color:var(--danger-color);padding:16px;">読み込みに失敗しました</td></tr>`;
      }
    }

    // ================== 顧客管理 ==================
    const customerState = {
      category: "sell",
      year: new Date().getFullYear(),
      customers: [],
      currentPage: 1,
      perPage: 20,
      editingCustomer: null,
      masters: {},
      statusColors: {}
    };

    async function initCustomerPage() {
      await loadCustomerMasters();
      await loadCustomerYears();
      await loadCustomers();
    }

    async function loadCustomerMasters() {
      try {
        customerState.masters = await apiFetch("/api/customer-masters");
        customerState.statusColors = customerState.masters.status_colors || {};
        applyCustomerMastersToForms();
      } catch (err) {
        console.error("顧客マスター取得エラー:", err);
      }
    }

    const CUSTOMER_KANA_MAP = {
      "ア": "ｱ", "イ": "ｲ", "ウ": "ｳ", "エ": "ｴ", "オ": "ｵ",
      "カ": "ｶ", "キ": "ｷ", "ク": "ｸ", "ケ": "ｹ", "コ": "ｺ",
      "サ": "ｻ", "シ": "ｼ", "ス": "ｽ", "セ": "ｾ", "ソ": "ｿ",
      "タ": "ﾀ", "チ": "ﾁ", "ツ": "ﾂ", "テ": "ﾃ", "ト": "ﾄ",
      "ナ": "ﾅ", "ニ": "ﾆ", "ヌ": "ﾇ", "ネ": "ﾈ", "ノ": "ﾉ",
      "ハ": "ﾊ", "ヒ": "ﾋ", "フ": "ﾌ", "ヘ": "ﾍ", "ホ": "ﾎ",
      "マ": "ﾏ", "ミ": "ﾐ", "ム": "ﾑ", "メ": "ﾒ", "モ": "ﾓ",
      "ヤ": "ﾔ", "ユ": "ﾕ", "ヨ": "ﾖ",
      "ラ": "ﾗ", "リ": "ﾘ", "ル": "ﾙ", "レ": "ﾚ", "ロ": "ﾛ",
      "ワ": "ﾜ", "ヲ": "ｦ", "ン": "ﾝ",
      "ァ": "ｧ", "ィ": "ｨ", "ゥ": "ｩ", "ェ": "ｪ", "ォ": "ｫ",
      "ッ": "ｯ", "ャ": "ｬ", "ュ": "ｭ", "ョ": "ｮ", "ヮ": "ﾜ",
      "ヵ": "ｶ", "ヶ": "ｹ", "ヰ": "ｲ", "ヱ": "ｴ",
      "ガ": "ｶﾞ", "ギ": "ｷﾞ", "グ": "ｸﾞ", "ゲ": "ｹﾞ", "ゴ": "ｺﾞ",
      "ザ": "ｻﾞ", "ジ": "ｼﾞ", "ズ": "ｽﾞ", "ゼ": "ｾﾞ", "ゾ": "ｿﾞ",
      "ダ": "ﾀﾞ", "ヂ": "ﾁﾞ", "ヅ": "ﾂﾞ", "デ": "ﾃﾞ", "ド": "ﾄﾞ",
      "バ": "ﾊﾞ", "ビ": "ﾋﾞ", "ブ": "ﾌﾞ", "ベ": "ﾍﾞ", "ボ": "ﾎﾞ",
      "パ": "ﾊﾟ", "ピ": "ﾋﾟ", "プ": "ﾌﾟ", "ペ": "ﾍﾟ", "ポ": "ﾎﾟ",
      "ヴ": "ｳﾞ", "\u30F7": "ﾜﾞ", "\u30F8": "ｲﾞ", "\u30F9": "ｴﾞ", "\u30FA": "ｦﾞ",
      "ー": "ｰ", "・": "･"
    };

    function toHalfwidthKana(value) {
      if (value === null || value === undefined) return value;
      const text = String(value);
      return text.replace(/[\u30A1-\u30FA\u30FC\u30FB]/g, (ch) => CUSTOMER_KANA_MAP[ch] || ch);
    }

    function getCustomerStatusStyle(status) {
      if (!status) return { bg: "#e5e7eb", color: "#374151" };
      const custom = customerState.statusColors[status];
      if (custom && custom.bg) return custom;
      return { bg: "#e5e7eb", color: "#374151" };
    }

    function onCustomerRowClick(event, customerId) {
      // ボタンクリック時は何もしない（ボタン側でstopPropagation済み）
      openCustomerDetail(customerId);
    }

    function applyCustomerMastersToForms() {
      const masters = customerState.masters;
      const category = customerState.category;

      // カテゴリに応じたステータスと反響媒体を取得
      const statusList = category === "sell" || category === "investment"
        ? (masters.status_sell || [])
        : (masters.status_buy || []);
      const inquirySourceList = category === "sell" || category === "investment"
        ? (masters.inquiry_source_sell || [])
        : (masters.inquiry_source_buy || []);

      // ステータスフィルター
      const statusFilter = el("customerStatusFilter");
      statusFilter.innerHTML = '<option value="">ｽﾃｰﾀｽ</option>' +
        statusList.map(s => `<option value="${s}">${toHalfwidthKana(s)}</option>`).join("");

      // 担当者フィルター（マスターから取得）
      const staffFilter = el("customerStaffFilter");
      staffFilter.innerHTML = '<option value="">担当者</option>' +
        (masters.staff || []).map(s => `<option value="${s}">${toHalfwidthKana(s)}</option>`).join("");

      // フォームの選択肢を更新
      const form = el("customerForm");

      // ステータス
      const statusSelect = form.querySelector('select[name="status"]');
      if (statusSelect) {
        statusSelect.innerHTML = statusList.map(s => `<option value="${s}">${toHalfwidthKana(s)}</option>`).join("");
      }

      // 反響媒体
      const inquirySourceSelect = form.querySelector('select[name="inquiry_source"]');
      if (inquirySourceSelect) {
        inquirySourceSelect.innerHTML = '<option value="">選択してください</option>' +
          inquirySourceList.map(s => `<option value="${s}">${toHalfwidthKana(s)}</option>`).join("");
      }

      // 連絡方法
      const contactMethodSelect = form.querySelector('select[name="contact_method"]');
      if (contactMethodSelect) {
        contactMethodSelect.innerHTML = '<option value="">選択してください</option>' +
          (masters.contact_method || []).map(s => `<option value="${s}">${toHalfwidthKana(s)}</option>`).join("");
      }

      // 物件種別
      const propertyTypeSelect = form.querySelector('select[name="property_type"]');
      if (propertyTypeSelect) {
        propertyTypeSelect.innerHTML = '<option value="">選択してください</option>' +
          (masters.property_type || []).map(s => `<option value="${s}">${toHalfwidthKana(s)}</option>`).join("");
      }

      // 担当者（フォーム用）
      const staffSelect = el("customerFormStaff");
      if (staffSelect) {
        staffSelect.innerHTML = (masters.staff || []).map(s => `<option value="${s}">${toHalfwidthKana(s)}</option>`).join("");
      }
    }

    async function openCustomerMastersModal() {
      const masters = customerState.masters;
      const form = el("customerMastersForm");

      form.elements["inquiry_source_sell"].value = (masters.inquiry_source_sell || []).join(", ");
      form.elements["inquiry_source_buy"].value = (masters.inquiry_source_buy || []).join(", ");
      form.elements["status_sell"].value = (masters.status_sell || []).join(", ");
      form.elements["status_buy"].value = (masters.status_buy || []).join(", ");
      form.elements["property_type"].value = (masters.property_type || []).join(", ");
      form.elements["contact_method"].value = (masters.contact_method || []).join(", ");
      form.elements["staff"].value = (masters.staff || []).join(", ");

      openModal("modalCustomerMasters");
    }

    async function saveCustomerMasters(e) {
      e.preventDefault();
      const form = el("customerMastersForm");

      const payload = {
        inquiry_source_sell: form.elements["inquiry_source_sell"].value,
        inquiry_source_buy: form.elements["inquiry_source_buy"].value,
        status_sell: form.elements["status_sell"].value,
        status_buy: form.elements["status_buy"].value,
        property_type: form.elements["property_type"].value,
        contact_method: form.elements["contact_method"].value,
        staff: form.elements["staff"].value
      };

      try {
        const result = await apiFetch("/api/customer-masters", { method: "PUT", body: JSON.stringify(payload) });
        customerState.masters = result.masters;
        customerState.statusColors = result.masters.status_colors || {};
        applyCustomerMastersToForms();
        closeModal("modalCustomerMasters");
      } catch (err) {
        alert("保存に失敗しました: " + (err.message || err));
      }
    }

    function getAllCustomerStatuses() {
      const set = new Set();
      const masters = customerState.masters;
      (masters.status_sell || []).forEach(s => set.add(s));
      (masters.status_buy || []).forEach(s => set.add(s));
      Object.keys(customerState.statusColors || {}).forEach(s => set.add(s));
      return Array.from(set).filter(s => s);
    }

    function renderCustomerStatusColorsForm() {
      const body = el("customerStatusColorsBody");
      if (!body) return;
      const statuses = getAllCustomerStatuses();
      const isColor = (v) => typeof v === "string" && /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v);

      body.innerHTML = statuses.map(s => {
        const style = getCustomerStatusStyle(s);
        const bg = isColor(style.bg) ? style.bg : "#e5e7eb";
        const color = isColor(style.color) ? style.color : "#111827";
        const statusLabel = toHalfwidthKana(s);
        return `<tr data-status="${s}">
          <td>${statusLabel}</td>
          <td><input type="color" name="bg" value="${bg}" onchange="updateCustomerStatusPreview(this)"></td>
          <td><input type="color" name="color" value="${color}" onchange="updateCustomerStatusPreview(this)"></td>
          <td><span class="customer-status-badge" style="background:${bg};color:${color};">${statusLabel}</span></td>
        </tr>`;
      }).join("");
    }

    function updateCustomerStatusPreview(input) {
      const row = input.closest("tr");
      const bgInput = row.querySelector('input[name="bg"]');
      const colorInput = row.querySelector('input[name="color"]');
      const preview = row.querySelector(".customer-status-badge");
      if (preview && bgInput && colorInput) {
        preview.style.background = bgInput.value;
        preview.style.color = colorInput.value;
      }
    }

    function openCustomerStatusColorsModal() {
      renderCustomerStatusColorsForm();
      openModal("modalCustomerStatusColors");
    }

    async function submitCustomerStatusColors(e) {
      e.preventDefault();
      const body = el("customerStatusColorsBody");
      const colors = {};
      body.querySelectorAll("tr[data-status]").forEach(row => {
        const status = row.dataset.status;
        const bg = row.querySelector('input[name="bg"]').value;
        const color = row.querySelector('input[name="color"]').value;
        colors[status] = { bg, color };
      });

      // マスターにstatus_colorsを含めて保存
      const payload = {
        ...customerState.masters,
        status_colors: colors
      };

      try {
        const result = await apiFetch("/api/customer-masters", { method: "PUT", body: JSON.stringify(payload) });
        customerState.masters = result.masters;
        customerState.statusColors = result.masters.status_colors || colors;
        closeModal("modalCustomerStatusColors");
        renderCustomerTable();
      } catch (err) {
        alert("保存に失敗しました: " + (err.message || err));
      }
    }

    async function loadCustomerYears() {
      try {
        const years = await apiFetch("/api/customers/years");
        const select = el("customerYear");
        select.innerHTML = years.map(y => `<option value="${y}" ${y === customerState.year ? 'selected' : ''}>${y}年</option>`).join("");
      } catch (err) {
        console.error("年度取得エラー:", err);
      }
    }

    async function loadCustomers() {
      try {
        const params = new URLSearchParams();
        const staff = el("customerStaffFilter").value;
        const status = el("customerStatusFilter").value;
        const keyword = el("customerKeyword").value;
        const dateFrom = el("customerDateFrom").value;
        const dateTo = el("customerDateTo").value;

        if (staff) params.append("staff", staff);
        if (status) params.append("status", status);
        if (keyword) params.append("keyword", keyword);
        if (dateFrom) params.append("date_from", dateFrom);
        if (dateTo) params.append("date_to", dateTo);

        const queryString = params.toString();
        const url = `/api/customers/${customerState.category}/${customerState.year}${queryString ? '?' + queryString : ''}`;

        const data = await apiFetch(url);
        customerState.customers = data.customers || [];
        customerState.currentPage = 1;

        renderCustomerTable();
        renderCustomerPagination();
        el("customerSummary").textContent = `${customerState.customers.length}件の顧客が見つかりました`;
      } catch (err) {
        console.error("顧客取得エラー:", err);
        el("customersBody").innerHTML = `<tr><td colspan="10" style="text-align:center;color:var(--danger-color);padding:20px;">データの読み込みに失敗しました</td></tr>`;
      }
    }

    function renderCustomerTable() {
      const start = (customerState.currentPage - 1) * customerState.perPage;
      const end = start + customerState.perPage;
      const pageCustomers = customerState.customers.slice(start, end);

      const thead = el("customersTableHead");
      const tbody = el("customersBody");

      // カテゴリ別ヘッダー
      const categoryHeaders = {
        sell: `<tr>
          <th>案件番号</th>
          <th>ｽﾃｰﾀｽ</th>
          <th>担当</th>
          <th>反響日</th>
          <th>反響</th>
          <th>種別</th>
          <th>査定住所</th>
          <th>氏名</th>
          <th>電話番号</th>
          <th>進捗</th>
          <th>操作</th>
        </tr>`,
        buy: `<tr>
          <th>案件番号</th>
          <th>ｽﾃｰﾀｽ</th>
          <th>担当</th>
          <th>反響日</th>
          <th>反響</th>
          <th>種別</th>
          <th>反響物件・価格</th>
          <th>氏名</th>
          <th>電話番号</th>
          <th>進捗</th>
          <th>操作</th>
        </tr>`,
        investment: `<tr>
          <th>案件番号</th>
          <th>ｽﾃｰﾀｽ</th>
          <th>担当</th>
          <th>反響日</th>
          <th>反響</th>
          <th>種別</th>
          <th>希望物件</th>
          <th>氏名</th>
          <th>電話番号</th>
          <th>進捗</th>
          <th>操作</th>
        </tr>`
      };

      thead.innerHTML = categoryHeaders[customerState.category];

      if (pageCustomers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;color:var(--gray-500);padding:32px;">顧客データがありません</td></tr>`;
        return;
      }

      const formatInquiryDateShort = (dateStr) => {
        if (!dateStr) return "-";
        const match = /^(\d{4})-(\d{2})-(\d{2})$/.exec(dateStr);
        if (!match) return dateStr;
        return `${match[1].slice(2)}-${match[2]}-${match[3]}`;
      };

      tbody.innerHTML = pageCustomers.map(c => {
        const statusClass = `status-${c.status}`;
        const progressHtml = renderProgressBadges(c, customerState.category);
        const propertyCol = customerState.category === "sell" ? (c.assessment_address || "-")
          : customerState.category === "buy" ? (c.target_property || "-")
          : (c.desired_property || "-");

        const statusStyle = getCustomerStatusStyle(c.status);
        const statusLabel = c.status ? toHalfwidthKana(c.status) : "-";
        const staffLabel = toHalfwidthKana(c.staff_id || "-");
        const inquirySourceLabel = toHalfwidthKana(c.inquiry_source || "-");
        const propertyTypeLabel = toHalfwidthKana(c.property_type || "-");
        const propertyLabel = toHalfwidthKana(propertyCol || "-");
        const customerNameLabel = toHalfwidthKana(c.customer_name || "-");
        const phoneLabel = toHalfwidthKana(c.phone || "-");
        const deleteName = toHalfwidthKana(c.customer_name || "");
        const inquiryDateLabel = formatInquiryDateShort(c.inquiry_date);

        return `<tr style="cursor:pointer;" onclick="onCustomerRowClick(event, '${c.id}')">
          <td style="white-space:nowrap;">${c.case_number || "-"}</td>
          <td><span class="customer-status-badge" style="background:${statusStyle.bg};color:${statusStyle.color};">${statusLabel}</span></td>
          <td style="white-space:nowrap;">${staffLabel}</td>
          <td style="white-space:nowrap;">${inquiryDateLabel}</td>
          <td style="white-space:nowrap;font-size:11px;">${inquirySourceLabel}</td>
          <td style="white-space:nowrap;font-size:11px;">${propertyTypeLabel}</td>
          <td style="max-width:120px;min-width:80px;font-size:11px;word-wrap:break-word;overflow-wrap:break-word;white-space:normal;" title="${propertyLabel}">${propertyLabel}</td>
          <td style="white-space:nowrap;">${customerNameLabel}</td>
          <td style="white-space:nowrap;font-size:11px;">${phoneLabel}</td>
          <td>${progressHtml}</td>
          <td style="white-space:nowrap;">
            <button class="btn btn-outline" style="padding:3px 6px;font-size:10px;" onclick="event.stopPropagation(); openEditCustomerModal('${c.id}')">編集</button>
            <button class="btn btn-outline" style="padding:3px 6px;font-size:10px;color:var(--danger-color);border-color:var(--danger-color);" onclick="event.stopPropagation(); deleteCustomerFromList('${c.id}', '${deleteName.replace(/'/g, "\\'")}')">削除</button>
          </td>
        </tr>`;
      }).join("");
    }

    function renderProgressBadges(customer, category) {
      const badges = [];
      // 架電は手動フラグ
      const firstCallDone = customer.first_call === "済";
      badges.push({ label: "架電", done: firstCallDone });

      if (category === "sell") {
        badges.push({ label: "査定", done: customer.pre_assessment === "済" });
        badges.push({ label: "媒介", done: customer.mediation === "済" });
        badges.push({ label: "契約", done: customer.contract === "済" });
      } else if (category === "buy") {
        badges.push({ label: "案内", done: customer.showing_status === "済" });
        badges.push({ label: "契約", done: customer.contract === "済" });
      } else {
        badges.push({ label: "案内", done: customer.showing_status === "済" });
        badges.push({ label: "契約", done: customer.contract === "済" });
      }

      const badgesHtml = badges.map(b => `<span class="progress-badge ${b.done ? 'done' : 'pending'}">${b.label}</span>`).join("");
      return `<div class="progress-badges-wrap">${badgesHtml}</div>`;
    }

    function renderCustomerPagination() {
      const totalPages = Math.ceil(customerState.customers.length / customerState.perPage);
      const pagination = el("customerPagination");

      if (totalPages <= 1) {
        pagination.innerHTML = "";
        return;
      }

      let html = "";
      html += `<button class="pagination-btn" onclick="goCustomerPage(1)" ${customerState.currentPage === 1 ? 'disabled' : ''}>≪</button>`;
      html += `<button class="pagination-btn" onclick="goCustomerPage(${customerState.currentPage - 1})" ${customerState.currentPage === 1 ? 'disabled' : ''}>‹</button>`;

      const startPage = Math.max(1, customerState.currentPage - 2);
      const endPage = Math.min(totalPages, customerState.currentPage + 2);

      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="pagination-btn ${i === customerState.currentPage ? 'active' : ''}" onclick="goCustomerPage(${i})">${i}</button>`;
      }

      html += `<button class="pagination-btn" onclick="goCustomerPage(${customerState.currentPage + 1})" ${customerState.currentPage === totalPages ? 'disabled' : ''}>›</button>`;
      html += `<button class="pagination-btn" onclick="goCustomerPage(${totalPages})" ${customerState.currentPage === totalPages ? 'disabled' : ''}>≫</button>`;

      pagination.innerHTML = html;
    }

    function goCustomerPage(page) {
      const totalPages = Math.ceil(customerState.customers.length / customerState.perPage);
      if (page < 1 || page > totalPages) return;
      customerState.currentPage = page;
      renderCustomerTable();
      renderCustomerPagination();
    }

    function switchCustomerCategory(category) {
      customerState.category = category;
      document.querySelectorAll(".customer-tab").forEach(tab => {
        tab.classList.toggle("active", tab.dataset.category === category);
      });
      showCategoryFields(category);
      applyCustomerMastersToForms(); // カテゴリ変更時に選択肢を更新
      loadCustomers();
    }

    function showCategoryFields(category) {
      document.getElementById("sellFields").classList.toggle("hidden", category !== "sell");
      document.getElementById("buyFields").classList.toggle("hidden", category !== "buy");
      document.getElementById("investmentFields").classList.toggle("hidden", category !== "investment");
    }

    function openNewCustomerModal() {
      customerState.editingCustomer = null;
      el("modalCustomerTitle").textContent = "新規顧客登録";
      el("customerForm").reset();
      el("customerFormCategory").value = customerState.category;
      showCategoryFields(customerState.category);

      // 現在日を反響日に設定
      el("customerForm").elements["inquiry_date"].value = new Date().toISOString().split("T")[0];

      // 現在ログイン中のユーザーを担当者に設定
      const staffSelect = el("customerFormStaff");
      if (state.currentUser) {
        for (let i = 0; i < staffSelect.options.length; i++) {
          if (staffSelect.options[i].value === state.currentUser) {
            staffSelect.selectedIndex = i;
            break;
          }
        }
      }

      openModal("modalCustomer");
    }

    async function openEditCustomerModal(customerId) {
      try {
        const customer = await apiFetch(`/api/customers/${customerState.category}/${customerState.year}/${customerId}`);
        customerState.editingCustomer = customer;

        el("modalCustomerTitle").textContent = "顧客編集";
        const form = el("customerForm");
        form.reset();
        el("customerFormCategory").value = customerState.category;
        showCategoryFields(customerState.category);

        // 共通フィールド
        form.elements["id"].value = customer.id;
        form.elements["case_number"].value = customer.case_number || "";
        form.elements["status"].value = customer.status || "未対応";
        form.elements["staff_id"].value = customer.staff_id || "";
        form.elements["inquiry_date"].value = customer.inquiry_date || "";
        form.elements["inquiry_source"].value = customer.inquiry_source || "";
        form.elements["contact_method"].value = customer.contact_method || "";
        form.elements["property_type"].value = customer.property_type || "";
        form.elements["customer_name"].value = customer.customer_name || "";
        form.elements["phone"].value = customer.phone || "";
        form.elements["current_address"].value = customer.current_address || "";
        form.elements["email"].value = customer.email || "";
        form.elements["memo"].value = customer.memo || "";

        // カテゴリ固有フィールド
        if (customerState.category === "sell") {
          form.elements["assessment_address"].value = customer.assessment_address || "";
          form.elements["sell_first_call"].checked = customer.first_call === "済";
          form.elements["call_status"].checked = customer.call_status === "済";
          form.elements["mail_status"].checked = customer.mail_status === "済";
          form.elements["sms_status"].checked = customer.sms_status === "済";
          form.elements["pre_assessment"].checked = customer.pre_assessment === "済";
          form.elements["mediation"].checked = customer.mediation === "済";
          form.elements["contract"].checked = customer.contract === "済";
        } else if (customerState.category === "buy") {
          form.elements["target_property"].value = customer.target_property || "";
          form.elements["buy_first_call"].checked = customer.first_call === "済";
          form.elements["buy_call_status"].checked = customer.call_status === "済";
          form.elements["buy_mail_status"].checked = customer.mail_status === "済";
          form.elements["showing_status"].checked = customer.showing_status === "済";
          form.elements["buy_contract"].checked = customer.contract === "済";
        } else {
          form.elements["desired_property"].value = customer.desired_property || "";
          form.elements["yield_rate"].value = customer.yield_rate || "";
          form.elements["expected_rent"].value = customer.expected_rent || "";
          form.elements["own_funds"].value = customer.own_funds || "";
          form.elements["loan_amount"].value = customer.loan_amount || "";
          form.elements["desired_area"].value = customer.desired_area || "";
          form.elements["inv_first_call"].checked = customer.first_call === "済";
          form.elements["inv_call_status"].checked = customer.call_status === "済";
          form.elements["inv_mail_status"].checked = customer.mail_status === "済";
          form.elements["inv_showing_status"].checked = customer.showing_status === "済";
          form.elements["inv_contract"].checked = customer.contract === "済";
        }

        openModal("modalCustomer");
      } catch (err) {
        alert("顧客データの取得に失敗しました");
      }
    }

    async function openCustomerDetail(customerId) {
      try {
        const customer = await apiFetch(`/api/customers/${customerState.category}/${customerState.year}/${customerId}`);
        customerState.editingCustomer = customer;

        const categoryNames = { sell: "売", buy: "買", investment: "収益" };
        const displayValue = (value) => toHalfwidthKana(value || "-");
        const statusLabel = customer.status ? toHalfwidthKana(customer.status) : "-";
        let html = `<div class="customer-detail-grid">
          <div class="customer-detail-label">ｶﾃｺﾞﾘ</div><div class="customer-detail-value">${displayValue(categoryNames[customerState.category])}</div>
          <div class="customer-detail-label">案件番号</div><div class="customer-detail-value">${displayValue(customer.case_number)}</div>
          <div class="customer-detail-label">ｽﾃｰﾀｽ</div><div class="customer-detail-value"><span class="customer-status-badge status-${customer.status}">${statusLabel}</span></div>
          <div class="customer-detail-label">担当者</div><div class="customer-detail-value">${displayValue(customer.staff_id)}</div>
          <div class="customer-detail-label">反響日</div><div class="customer-detail-value">${displayValue(customer.inquiry_date)}</div>
          <div class="customer-detail-label">反響</div><div class="customer-detail-value">${displayValue(customer.inquiry_source)}</div>
          <div class="customer-detail-label">連絡方法</div><div class="customer-detail-value">${displayValue(customer.contact_method)}</div>
          <div class="customer-detail-label">種別</div><div class="customer-detail-value">${displayValue(customer.property_type)}</div>
          <div class="customer-detail-label">氏名</div><div class="customer-detail-value">${displayValue(customer.customer_name)}</div>
          <div class="customer-detail-label">電話番号</div><div class="customer-detail-value">${displayValue(customer.phone)}</div>
          <div class="customer-detail-label">現住所</div><div class="customer-detail-value">${displayValue(customer.current_address)}</div>
          <div class="customer-detail-label">ﾒｰﾙ</div><div class="customer-detail-value">${displayValue(customer.email)}</div>`;

        if (customerState.category === "sell") {
          html += `<div class="customer-detail-label">査定住所</div><div class="customer-detail-value">${displayValue(customer.assessment_address)}</div>`;
        } else if (customerState.category === "buy") {
          html += `<div class="customer-detail-label">反響物件・価格</div><div class="customer-detail-value">${displayValue(customer.target_property)}</div>`;
        } else {
          html += `<div class="customer-detail-label">希望物件</div><div class="customer-detail-value">${displayValue(customer.desired_property)}</div>
            <div class="customer-detail-label">利回り希望</div><div class="customer-detail-value">${customer.yield_rate ? customer.yield_rate + "%" : "-"}</div>
            <div class="customer-detail-label">想定家賃</div><div class="customer-detail-value">${customer.expected_rent ? customer.expected_rent.toLocaleString() + "円/月" : "-"}</div>
            <div class="customer-detail-label">自己資金</div><div class="customer-detail-value">${customer.own_funds ? customer.own_funds.toLocaleString() + "万円" : "-"}</div>
            <div class="customer-detail-label">融資希望額</div><div class="customer-detail-value">${customer.loan_amount ? customer.loan_amount.toLocaleString() + "万円" : "-"}</div>
            <div class="customer-detail-label">希望ｴﾘｱ</div><div class="customer-detail-value">${displayValue(customer.desired_area)}</div>`;
        }

        html += `<div class="customer-detail-label">ﾒﾓ</div><div class="customer-detail-value">${displayValue(customer.memo)}</div>
          <div class="customer-detail-label">登録日</div><div class="customer-detail-value">${customer.created_at ? customer.created_at.split("T")[0] : "-"}</div>
          <div class="customer-detail-label">更新日</div><div class="customer-detail-value">${customer.updated_at ? customer.updated_at.split("T")[0] : "-"}</div>
        </div>`;

        html += `<div style="margin-top:16px;"><strong>進捗状況:</strong><div style="margin-top:8px;">${renderProgressBadges(customer, customerState.category)}</div></div>`;

        el("customerDetailBody").innerHTML = html;
        openModal("modalCustomerDetail");
      } catch (err) {
        alert("顧客データの取得に失敗しました");
      }
    }

    async function saveCustomer(e) {
      e.preventDefault();
      const form = el("customerForm");
      const formData = new FormData(form);
      const category = customerState.category;

      const payload = {
        status: formData.get("status"),
        staff_id: formData.get("staff_id"),
        inquiry_date: formData.get("inquiry_date"),
        inquiry_source: formData.get("inquiry_source"),
        contact_method: formData.get("contact_method"),
        property_type: formData.get("property_type"),
        customer_name: formData.get("customer_name"),
        phone: formData.get("phone"),
        current_address: formData.get("current_address"),
        email: formData.get("email"),
        memo: formData.get("memo")
      };

      if (category === "sell") {
        payload.assessment_address = formData.get("assessment_address");
        payload.first_call = form.elements["sell_first_call"].checked ? "済" : "未";
        payload.call_status = form.elements["call_status"].checked ? "済" : "未";
        payload.mail_status = form.elements["mail_status"].checked ? "済" : "未";
        payload.sms_status = form.elements["sms_status"].checked ? "済" : "未";
        payload.pre_assessment = form.elements["pre_assessment"].checked ? "済" : "未";
        payload.mediation = form.elements["mediation"].checked ? "済" : "未";
        payload.contract = form.elements["contract"].checked ? "済" : "未";
      } else if (category === "buy") {
        payload.target_property = formData.get("target_property");
        payload.first_call = form.elements["buy_first_call"].checked ? "済" : "未";
        payload.call_status = form.elements["buy_call_status"].checked ? "済" : "未";
        payload.mail_status = form.elements["buy_mail_status"].checked ? "済" : "未";
        payload.showing_status = form.elements["showing_status"].checked ? "済" : "未";
        payload.contract = form.elements["buy_contract"].checked ? "済" : "未";
      } else {
        payload.desired_property = formData.get("desired_property");
        payload.yield_rate = formData.get("yield_rate") ? parseFloat(formData.get("yield_rate")) : null;
        payload.expected_rent = formData.get("expected_rent") ? parseInt(formData.get("expected_rent")) : null;
        payload.own_funds = formData.get("own_funds") ? parseInt(formData.get("own_funds")) : null;
        payload.loan_amount = formData.get("loan_amount") ? parseInt(formData.get("loan_amount")) : null;
        payload.desired_area = formData.get("desired_area");
        payload.first_call = form.elements["inv_first_call"].checked ? "済" : "未";
        payload.call_status = form.elements["inv_call_status"].checked ? "済" : "未";
        payload.mail_status = form.elements["inv_mail_status"].checked ? "済" : "未";
        payload.showing_status = form.elements["inv_showing_status"].checked ? "済" : "未";
        payload.contract = form.elements["inv_contract"].checked ? "済" : "未";
      }

      try {
        const customerId = formData.get("id");
        if (customerId && customerState.editingCustomer) {
          // 更新
          await apiFetch(`/api/customers/${category}/${customerState.year}/${customerId}`, { method: "PUT", body: JSON.stringify(payload) });
        } else {
          // 新規作成
          await apiFetch(`/api/customers/${category}/${customerState.year}`, { method: "POST", body: JSON.stringify(payload) });
        }
        closeModal("modalCustomer");
        await loadCustomers();
      } catch (err) {
        alert("保存に失敗しました: " + (err.message || err));
      }
    }

    async function deleteCustomer() {
      if (!customerState.editingCustomer) return;
      if (!confirm(`「${customerState.editingCustomer.customer_name}」を削除しますか？\n\nこの操作は取り消せません。`)) return;

      try {
        await apiFetch(`/api/customers/${customerState.category}/${customerState.year}/${customerState.editingCustomer.id}`, { method: "DELETE" });
        closeModal("modalCustomerDetail");
        await loadCustomers();
      } catch (err) {
        alert("削除に失敗しました: " + (err.message || err));
      }
    }

    async function deleteCustomerFromList(customerId, customerName) {
      if (!confirm(`「${customerName || '顧客'}」を削除しますか？\n\n削除後、案件番号が自動的に再採番されます。\nこの操作は取り消せません。`)) return;

      try {
        await apiFetch(`/api/customers/${customerState.category}/${customerState.year}/${customerId}`, { method: "DELETE" });
        await loadCustomers();
      } catch (err) {
        alert("削除に失敗しました: " + (err.message || err));
      }
    }

    function exportCustomers() {
      const url = `/api/customers/${customerState.category}/${customerState.year}/export`;
      window.open(url, "_blank");
    }

    async function reassignCaseNumbers() {
      const categoryNames = { sell: "売", buy: "買", investment: "収益" };
      const msg = `${customerState.year}年の${categoryNames[customerState.category]}顧客の案件番号を\n反響日順に振り直しますか？\n\n※既存の案件番号はすべて変更されます`;

      if (!confirm(msg)) return;

      try {
        const result = await apiFetch(`/api/customers/reassign/${customerState.category}/${customerState.year}`, { method: "POST" });
        alert(`${result.reassigned_count}件の案件番号を再採番しました`);
        await loadCustomers();
      } catch (err) {
        alert("再採番に失敗しました: " + (err.message || err));
      }
    }

    function resetCustomerFilters() {
      el("customerStaffFilter").value = "";
      el("customerStatusFilter").value = "";
      el("customerDateFrom").value = "";
      el("customerDateTo").value = "";
      el("customerKeyword").value = "";
      loadCustomers();
    }

    // 顧客管理イベントリスナー
    document.querySelectorAll(".customer-tab").forEach(tab => {
      tab.addEventListener("click", () => switchCustomerCategory(tab.dataset.category));
    });

    // 年度変更
    el("customerYear").addEventListener("change", (e) => {
      customerState.year = parseInt(e.target.value);
      loadCustomers();
    });

    // フィルター即時反映（プルダウン変更時）
    el("customerStaffFilter").addEventListener("change", loadCustomers);
    el("customerStatusFilter").addEventListener("change", loadCustomers);
    el("customerDateFrom").addEventListener("change", loadCustomers);
    el("customerDateTo").addEventListener("change", loadCustomers);

    // キーワード検索（Enter or 入力後少し待って反映）
    let keywordTimer = null;
    el("customerKeyword").addEventListener("input", () => {
      clearTimeout(keywordTimer);
      keywordTimer = setTimeout(loadCustomers, 400);
    });
    el("customerKeyword").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        clearTimeout(keywordTimer);
        loadCustomers();
      }
    });

    // 表示件数変更
    el("customerPerPage").addEventListener("change", (e) => {
      customerState.perPage = parseInt(e.target.value);
      customerState.currentPage = 1;
      renderCustomerTable();
      renderCustomerPagination();
    });

    el("btnCustomerReset").addEventListener("click", resetCustomerFilters);
    el("btnNewCustomer").addEventListener("click", openNewCustomerModal);
    el("btnReassignCaseNumbers").addEventListener("click", reassignCaseNumbers);
    el("btnExportCustomers").addEventListener("click", exportCustomers);
    el("btnCustomerMasters").addEventListener("click", openCustomerMastersModal);
    el("btnCustomerStatusColors").addEventListener("click", openCustomerStatusColorsModal);
    el("customerForm").addEventListener("submit", saveCustomer);
    el("customerMastersForm").addEventListener("submit", saveCustomerMasters);
    el("customerStatusColorsForm").addEventListener("submit", submitCustomerStatusColors);
    el("btnEditCustomerFromDetail").addEventListener("click", () => {
      closeModal("modalCustomerDetail");
      if (customerState.editingCustomer) {
        openEditCustomerModal(customerState.editingCustomer.id);
      }
    });
    el("btnDeleteCustomerFromDetail").addEventListener("click", deleteCustomer);
    el("btnEmailAnalysis").addEventListener("click", openEmailAnalysisModal);
    el("emailAnalysisInput").addEventListener("input", analyzeEmailContent);
    el("btnApplyEmailAnalysis").addEventListener("click", applyEmailAnalysisToForm);

    // ================== 反響メール分析機能 ==================
    let emailAnalysisData = {};

    function openEmailAnalysisModal() {
      el("emailAnalysisInput").value = "";
      el("emailAnalysisResult").innerHTML = '<span style="color:var(--gray-400);">ﾒｰﾙ本文を入力すると、ここに抽出結果が表示されます</span>';
      emailAnalysisData = {};

      // カテゴリに応じてモーダルタイトルと説明を変更
      const category = customerState.category;
      if (category === "sell") {
        el("modalEmailAnalysisTitle").textContent = "📧 反響ﾒｰﾙ分析（売）";
        el("emailAnalysisDesc").textContent = "売反響ﾒｰﾙの本文を貼り付けると、顧客情報を自動抽出します。";
      } else {
        el("modalEmailAnalysisTitle").textContent = "📧 反響ﾒｰﾙ分析（買）";
        el("emailAnalysisDesc").textContent = "買反響ﾒｰﾙの本文を貼り付けると、顧客情報を自動抽出します。";
      }

      openModal("modalEmailAnalysis");
    }

    function analyzeEmailContent() {
      const text = el("emailAnalysisInput").value;
      if (!text.trim()) {
        el("emailAnalysisResult").innerHTML = '<span style="color:var(--gray-400);">ﾒｰﾙ本文を入力すると、ここに抽出結果が表示されます</span>';
        emailAnalysisData = {};
        return;
      }

      const category = customerState.category;
      const data = parseEmailContent(text, category);
      emailAnalysisData = data;
      renderEmailAnalysisResult(data, category);
    }

    function parseEmailContent(text, category) {
      const result = {};

      // ========== 売り専用：反響媒体 ==========
      if (category === "sell") {
        const sellSourcePatterns = [
          { pattern: /スーモ|SUUMO|suumo/i, value: "スーモ" },
          { pattern: /アットホーム|at\s*home|athome/i, value: "アットホーム" },
          { pattern: /ホームズ|HOMES|homes|HOME'S/i, value: "ホームズ" },
          { pattern: /イクラ不動産|イクラ/i, value: "イクラ" },
          { pattern: /リビンマッチ/i, value: "リビンマッチ" },
          { pattern: /イエウール/i, value: "イエウール" },
          { pattern: /おうちクラベル|おウチクラベル/i, value: "おうちクラベル" },
          { pattern: /すまいステップ/i, value: "すまいステップ" },
          { pattern: /すまいValue/i, value: "すまいValue" },
          { pattern: /テマキ/i, value: "テマキ" },
          { pattern: /ポスティング/i, value: "ポスティング" },
          { pattern: /自社HP|自社ホームページ/i, value: "自社HP" },
          { pattern: /C21|センチュリー21/i, value: "C21HP" },
          { pattern: /SNS|インスタ|Instagram|Twitter|Facebook/i, value: "SNS" },
          { pattern: /来店/i, value: "来店" },
          { pattern: /看板/i, value: "看板等" },
          { pattern: /紹介/i, value: "紹介" }
        ];
        for (const sp of sellSourcePatterns) {
          if (sp.pattern.test(text)) {
            result.inquiry_source = sp.value;
            break;
          }
        }
      } else {
        // ========== 買い・収益用：反響媒体 ==========
        const buySourcePatterns = [
          { pattern: /スーモ|SUUMO|suumo/i, value: "スーモ" },
          { pattern: /アットホーム|at\s*home|athome/i, value: "アットホーム" },
          { pattern: /ホームズ|HOMES|homes|HOME'S/i, value: "ホームズ" },
          { pattern: /自社HP|自社ホームページ/i, value: "自社HP" },
          { pattern: /C21|センチュリー21/i, value: "C21HP" },
          { pattern: /SNS|インスタ|Instagram|Twitter|Facebook/i, value: "SNS" },
          { pattern: /来店/i, value: "来店" },
          { pattern: /看板/i, value: "看板等" },
          { pattern: /テマキ/i, value: "テマキ" },
          { pattern: /紹介/i, value: "紹介" },
          { pattern: /隣地/i, value: "隣地" }
        ];
        for (const sp of buySourcePatterns) {
          if (sp.pattern.test(text)) {
            result.inquiry_source = sp.value;
            break;
          }
        }
      }

      // ========== 共通：氏名を抽出 ==========
      const namePatterns = [
        /(?:お名前|氏名|名前|ご氏名|お客様名|顧客名)[：:\s]*([^\n\r<>]+)/i,
        /(?:Name|name)[：:\s]*([^\n\r<>]+)/i,
        /([一-龥ぁ-んァ-ン]+)\s*様/
      ];
      for (const pattern of namePatterns) {
        const match = text.match(pattern);
        if (match) {
          result.customer_name = match[1].trim().replace(/[\s　]+/g, " ").replace(/様$/, "");
          break;
        }
      }

      // ========== 共通：電話番号を抽出 ==========
      const phonePatterns = [
        /(?:電話番号|TEL|tel|電話|携帯|お電話)[：:\s]*([\d\-()（）]+)/i,
        /(?:Phone|phone)[：:\s]*([\d\-()（）]+)/i,
        /(0\d{1,4}[\-\s]?\d{1,4}[\-\s]?\d{3,4})/
      ];
      for (const pattern of phonePatterns) {
        const match = text.match(pattern);
        if (match) {
          result.phone = match[1].trim().replace(/[（）()]/g, "").replace(/[\s]/g, "-");
          break;
        }
      }

      // ========== 共通：メールアドレスを抽出 ==========
      const emailPattern = /(?:メール|メールアドレス|E-?mail|mail)[：:\s]*([a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,})/i;
      const emailMatch = text.match(emailPattern);
      if (emailMatch) {
        result.email = emailMatch[1].trim();
      } else {
        const standaloneEmail = text.match(/([a-zA-Z0-9._%+\-]+@[a-zA-Z0-9.\-]+\.[a-zA-Z]{2,})/);
        if (standaloneEmail) {
          result.email = standaloneEmail[1];
        }
      }

      // ========== 共通：物件種別を検出 ==========
      const propertyPatterns = [
        { pattern: /マンション/i, value: "マンション" },
        { pattern: /(?:中古)?戸建[てて]?|一戸建/i, value: "戸建て" },
        { pattern: /土地/i, value: "土地" },
        { pattern: /収益|投資|アパート/i, value: "収益物件" }
      ];
      for (const pp of propertyPatterns) {
        if (pp.pattern.test(text)) {
          result.property_type = pp.value;
          break;
        }
      }

      // ========== 売り専用：査定住所を抽出 ==========
      if (category === "sell") {
        const assessmentAddressPatterns = [
          /(?:査定住所|査定物件住所|査定対象|売却物件|売却希望物件|物件所在地|物件住所|対象物件住所)[：:\s]*([^\n\r]+)/i,
          /(?:所在地|住所)[：:\s]*([^\n\r]+)/i,
          /(?:東京都|神奈川県|埼玉県|千葉県|大阪府|京都府|兵庫県|愛知県|福岡県|北海道|[一-龥]{2,3}県)[^\n\r]{5,50}/
        ];
        for (const pattern of assessmentAddressPatterns) {
          const match = text.match(pattern);
          if (match) {
            result.assessment_address = match[1] ? match[1].trim() : match[0].trim();
            break;
          }
        }

        // 現住所を抽出
        const currentAddressPatterns = [
          /(?:現住所|お住まい|ご住所|連絡先住所)[：:\s]*([^\n\r]+)/i
        ];
        for (const pattern of currentAddressPatterns) {
          const match = text.match(pattern);
          if (match) {
            result.current_address = match[1].trim();
            break;
          }
        }
      } else {
        // ========== 買い・収益専用：反響物件を抽出 ==========
        const targetPropertyPatterns = [
          /(?:お問い?合わせ物件|対象物件|ご希望物件|物件名|反響物件|検討物件)[：:\s]*([^\n\r]+)/i,
          /(?:物件所在地|物件住所|所在地)[：:\s]*([^\n\r]+)/i,
          /(?:東京都|神奈川県|埼玉県|千葉県|大阪府|京都府|兵庫県|愛知県|福岡県|北海道|[一-龥]{2,3}県)[^\n\r]{5,50}/
        ];
        for (const pattern of targetPropertyPatterns) {
          const match = text.match(pattern);
          if (match) {
            result.target_property = match[1] ? match[1].trim() : match[0].trim();
            break;
          }
        }

        // 現住所を抽出
        const currentAddressPatterns = [
          /(?:現住所|お住まい|ご住所|連絡先住所)[：:\s]*([^\n\r]+)/i
        ];
        for (const pattern of currentAddressPatterns) {
          const match = text.match(pattern);
          if (match) {
            result.current_address = match[1].trim();
            break;
          }
        }
      }

      // ========== 共通：問い合わせ内容・備考をメモに ==========
      const inquiryPatterns = [
        /(?:お問い?合わせ内容|ご質問|ご要望|備考|コメント|メッセージ)[：:\s]*([^\n\r]+(?:\n(?![一-龥]+[：:]).*)*)/i
      ];
      for (const pattern of inquiryPatterns) {
        const match = text.match(pattern);
        if (match) {
          result.memo = match[1].trim();
          break;
        }
      }

      return result;
    }

    function renderEmailAnalysisResult(data, category) {
      // カテゴリに応じて表示フィールドを変更
      let fields;
      if (category === "sell") {
        fields = [
          { key: "inquiry_source", label: "反響" },
          { key: "customer_name", label: "氏名" },
          { key: "phone", label: "電話番号" },
          { key: "email", label: "ﾒｰﾙｱﾄﾞﾚｽ" },
          { key: "assessment_address", label: "査定住所" },
          { key: "current_address", label: "現住所" },
          { key: "property_type", label: "種別" },
          { key: "memo", label: "ﾒﾓ" }
        ];
      } else {
        fields = [
          { key: "inquiry_source", label: "反響" },
          { key: "customer_name", label: "氏名" },
          { key: "phone", label: "電話番号" },
          { key: "email", label: "ﾒｰﾙｱﾄﾞﾚｽ" },
          { key: "target_property", label: "反響物件・価格" },
          { key: "current_address", label: "現住所" },
          { key: "property_type", label: "種別" },
          { key: "memo", label: "ﾒﾓ" }
        ];
      }

      const hasData = Object.keys(data).length > 0;
      if (!hasData) {
        el("emailAnalysisResult").innerHTML = '<span style="color:var(--warning-color);">情報を抽出できませんでした。ﾒｰﾙ形式を確認してください。</span>';
        return;
      }

      let html = '<table style="width:100%;font-size:12px;"><tbody>';
      for (const field of fields) {
        const value = data[field.key];
        if (value) {
          const displayValue = toHalfwidthKana(value);
          html += `<tr>
            <td style="padding:4px 8px;font-weight:600;color:var(--gray-600);width:100px;">${field.label}</td>
            <td style="padding:4px 8px;color:var(--gray-800);">${escapeHtml(displayValue)}</td>
          </tr>`;
        }
      }
      html += '</tbody></table>';

      const extractedCount = Object.keys(data).length;
      html = `<div style="margin-bottom:8px;color:var(--success-color);font-weight:600;">✅ ${extractedCount}件の情報を抽出しました</div>` + html;

      el("emailAnalysisResult").innerHTML = html;
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function applyEmailAnalysisToForm() {
      const data = emailAnalysisData;
      if (!data || Object.keys(data).length === 0) {
        alert("抽出されたデータがありません");
        return;
      }

      const form = el("customerForm");
      const category = customerState.category;

      // 共通フィールドに値を設定
      if (data.customer_name) form.elements["customer_name"].value = data.customer_name;
      if (data.phone) form.elements["phone"].value = data.phone;
      if (data.email) form.elements["email"].value = data.email;
      if (data.current_address) form.elements["current_address"].value = data.current_address;
      if (data.memo) form.elements["memo"].value = data.memo;

      // 反響媒体（selectの場合、選択肢に存在するか確認）
      if (data.inquiry_source) {
        const sourceSelect = form.elements["inquiry_source"];
        for (let i = 0; i < sourceSelect.options.length; i++) {
          if (sourceSelect.options[i].value === data.inquiry_source) {
            sourceSelect.selectedIndex = i;
            break;
          }
        }
      }

      // 物件種別
      if (data.property_type) {
        const typeSelect = form.elements["property_type"];
        for (let i = 0; i < typeSelect.options.length; i++) {
          if (typeSelect.options[i].value === data.property_type) {
            typeSelect.selectedIndex = i;
            break;
          }
        }
      }

      // カテゴリ別フィールド
      if (category === "sell") {
        if (data.assessment_address) {
          form.elements["assessment_address"].value = data.assessment_address;
        }
      } else if (category === "buy") {
        if (data.target_property) {
          form.elements["target_property"].value = data.target_property;
        }
      } else if (category === "investment") {
        if (data.target_property) {
          form.elements["desired_property"].value = data.target_property;
        }
      }

      closeModal("modalEmailAnalysis");
    }

    // 顧客管理ページ表示時に初期化
    const originalShowPage = showPage;
    showPage = function(page) {
      originalShowPage(page);
      if (page === "customers") {
        initCustomerPage();
      }
    };

  </script>
</body>
</html>












